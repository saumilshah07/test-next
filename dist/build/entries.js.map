{"version":3,"sources":["../../build/entries.ts"],"sourcesContent":["import chalk from 'chalk'\nimport { posix, join } from 'path'\nimport { stringify } from 'querystring'\nimport { API_ROUTE, DOT_NEXT_ALIAS, PAGES_DIR_ALIAS } from '../lib/constants'\nimport { __ApiPreviewProps } from '../server/api-utils'\nimport { isTargetLikeServerless } from '../server/config'\nimport { normalizePagePath } from '../server/normalize-page-path'\nimport { warn } from './output/log'\nimport { ClientPagesLoaderOptions } from './webpack/loaders/next-client-pages-loader'\nimport { ServerlessLoaderQuery } from './webpack/loaders/next-serverless-loader'\nimport { LoadedEnvFiles } from '@next/env'\nimport { NextConfigComplete } from '../server/config-shared'\n\ntype PagesMapping = {\n  [page: string]: string\n}\n\nexport function createPagesMapping(\n  pagePaths: string[],\n  extensions: string[],\n  isWebpack5: boolean,\n  isDev: boolean\n): PagesMapping {\n  const previousPages: PagesMapping = {}\n  const pages: PagesMapping = pagePaths.reduce(\n    (result: PagesMapping, pagePath): PagesMapping => {\n      let page = `${pagePath\n        .replace(new RegExp(`\\\\.+(${extensions.join('|')})$`), '')\n        .replace(/\\\\/g, '/')}`.replace(/\\/index$/, '')\n\n      const pageKey = page === '' ? '/' : page\n\n      if (pageKey in result) {\n        warn(\n          `Duplicate page detected. ${chalk.cyan(\n            join('pages', previousPages[pageKey])\n          )} and ${chalk.cyan(\n            join('pages', pagePath)\n          )} both resolve to ${chalk.cyan(pageKey)}.`\n        )\n      } else {\n        previousPages[pageKey] = pagePath\n      }\n      result[pageKey] = join(PAGES_DIR_ALIAS, pagePath).replace(/\\\\/g, '/')\n      return result\n    },\n    {}\n  )\n\n  // we alias these in development and allow webpack to\n  // allow falling back to the correct source file so\n  // that HMR can work properly when a file is added/removed\n  if (isWebpack5 && isDev) {\n    pages['/_app'] = `${PAGES_DIR_ALIAS}/_app`\n    pages['/_error'] = `${PAGES_DIR_ALIAS}/_error`\n    pages['/_document'] = `${PAGES_DIR_ALIAS}/_document`\n  } else {\n    pages['/_app'] = pages['/_app'] || 'next/dist/pages/_app'\n    pages['/_error'] = pages['/_error'] || 'next/dist/pages/_error'\n    pages['/_document'] = pages['/_document'] || 'next/dist/pages/_document'\n  }\n  return pages\n}\n\nexport type WebpackEntrypoints = {\n  [bundle: string]:\n    | string\n    | string[]\n    | {\n        import: string | string[]\n        dependOn?: string | string[]\n      }\n}\n\ntype Entrypoints = {\n  client: WebpackEntrypoints\n  server: WebpackEntrypoints\n}\n\nexport function createEntrypoints(\n  pages: PagesMapping,\n  target: 'server' | 'serverless' | 'experimental-serverless-trace',\n  buildId: string,\n  previewMode: __ApiPreviewProps,\n  config: NextConfigComplete,\n  loadedEnvFiles: LoadedEnvFiles\n): Entrypoints {\n  const client: WebpackEntrypoints = {}\n  const server: WebpackEntrypoints = {}\n\n  const hasRuntimeConfig =\n    Object.keys(config.publicRuntimeConfig).length > 0 ||\n    Object.keys(config.serverRuntimeConfig).length > 0\n\n  const defaultServerlessOptions = {\n    absoluteAppPath: pages['/_app'],\n    absoluteDocumentPath: pages['/_document'],\n    absoluteErrorPath: pages['/_error'],\n    absolute404Path: pages['/404'] || '',\n    distDir: DOT_NEXT_ALIAS,\n    buildId,\n    assetPrefix: config.assetPrefix,\n    generateEtags: config.generateEtags ? 'true' : '',\n    poweredByHeader: config.poweredByHeader ? 'true' : '',\n    canonicalBase: config.amp.canonicalBase || '',\n    basePath: config.basePath,\n    runtimeConfig: hasRuntimeConfig\n      ? JSON.stringify({\n          publicRuntimeConfig: config.publicRuntimeConfig,\n          serverRuntimeConfig: config.serverRuntimeConfig,\n        })\n      : '',\n    previewProps: JSON.stringify(previewMode),\n    // base64 encode to make sure contents don't break webpack URL loading\n    loadedEnvFiles: Buffer.from(JSON.stringify(loadedEnvFiles)).toString(\n      'base64'\n    ),\n    i18n: config.i18n ? JSON.stringify(config.i18n) : '',\n  }\n\n  Object.keys(pages).forEach((page) => {\n    const absolutePagePath = pages[page]\n    const bundleFile = normalizePagePath(page)\n    const isApiRoute = page.match(API_ROUTE)\n\n    const clientBundlePath = posix.join('pages', bundleFile)\n    const serverBundlePath = posix.join('pages', bundleFile)\n\n    const isLikeServerless = isTargetLikeServerless(target)\n\n    if (isApiRoute && isLikeServerless) {\n      const serverlessLoaderOptions: ServerlessLoaderQuery = {\n        page,\n        absolutePagePath,\n        ...defaultServerlessOptions,\n      }\n      server[serverBundlePath] = `next-serverless-loader?${stringify(\n        serverlessLoaderOptions\n      )}!`\n    } else if (isApiRoute || target === 'server') {\n      server[serverBundlePath] = [absolutePagePath]\n    } else if (isLikeServerless && page !== '/_app' && page !== '/_document') {\n      const serverlessLoaderOptions: ServerlessLoaderQuery = {\n        page,\n        absolutePagePath,\n        ...defaultServerlessOptions,\n      }\n      server[serverBundlePath] = `next-serverless-loader?${stringify(\n        serverlessLoaderOptions\n      )}!`\n    }\n\n    if (page === '/_document') {\n      return\n    }\n\n    if (!isApiRoute) {\n      const pageLoaderOpts: ClientPagesLoaderOptions = {\n        page,\n        absolutePagePath,\n      }\n      const pageLoader = `next-client-pages-loader?${stringify(\n        pageLoaderOpts\n      )}!`\n\n      // Make sure next/router is a dependency of _app or else chunk splitting\n      // might cause the router to not be able to load causing hydration\n      // to fail\n\n      client[clientBundlePath] =\n        page === '/_app'\n          ? [pageLoader, require.resolve('../client/router')]\n          : pageLoader\n    }\n  })\n\n  return {\n    client,\n    server,\n  }\n}\n"],"names":["createPagesMapping","createEntrypoints","pagePaths","extensions","isWebpack5","isDev","previousPages","pages","reduce","result","pagePath","page","replace","RegExp","join","pageKey","cyan","target","buildId","previewMode","config","loadedEnvFiles","client","server","hasRuntimeConfig","Object","keys","publicRuntimeConfig","length","serverRuntimeConfig","defaultServerlessOptions","absoluteAppPath","absoluteDocumentPath","absoluteErrorPath","absolute404Path","distDir","assetPrefix","generateEtags","poweredByHeader","canonicalBase","amp","basePath","runtimeConfig","JSON","stringify","previewProps","Buffer","from","toString","i18n","forEach","absolutePagePath","bundleFile","isApiRoute","match","clientBundlePath","serverBundlePath","isLikeServerless","serverlessLoaderOptions","pageLoaderOpts","pageLoader","require","resolve"],"mappings":"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"}