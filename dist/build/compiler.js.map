{"version":3,"sources":["../../build/compiler.ts"],"sourcesContent":["import { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { Span } from '../telemetry/trace'\n\nexport type CompilerResult = {\n  errors: string[]\n  warnings: string[]\n}\n\nfunction generateStats(\n  result: CompilerResult,\n  stat: webpack.Stats\n): CompilerResult {\n  const { errors, warnings } = stat.toJson('errors-warnings')\n  if (errors.length > 0) {\n    result.errors.push(...errors)\n  }\n\n  if (warnings.length > 0) {\n    result.warnings.push(...warnings)\n  }\n\n  return result\n}\n\n// Webpack 5 requires the compiler to be closed (to save caches)\n// Webpack 4 does not have this close method so in order to be backwards compatible we check if it exists\nfunction closeCompiler(compiler: webpack.Compiler | webpack.MultiCompiler) {\n  return new Promise<void>((resolve, reject) => {\n    if ('close' in compiler) {\n      // @ts-ignore Close only exists on the compiler in webpack 5\n      return compiler.close((err: any) => (err ? reject(err) : resolve()))\n    }\n\n    resolve()\n  })\n}\n\nexport function runCompiler(\n  config: webpack.Configuration,\n  { runWebpackSpan }: { runWebpackSpan: Span }\n): Promise<CompilerResult> {\n  return new Promise((resolve, reject) => {\n    const compiler = webpack(config)\n    compiler.run((err: Error, stats: webpack.Stats) => {\n      const webpackCloseSpan = runWebpackSpan.traceChild('webpack-close')\n      webpackCloseSpan\n        .traceAsyncFn(() => closeCompiler(compiler))\n        .then(() => {\n          if (err) {\n            const reason = err?.toString()\n            if (reason) {\n              return resolve({ errors: [reason], warnings: [] })\n            }\n            return reject(err)\n          }\n\n          const result = webpackCloseSpan\n            .traceChild('webpack-generate-error-stats')\n            .traceFn(() => generateStats({ errors: [], warnings: [] }, stats))\n          return resolve(result)\n        })\n    })\n  })\n}\n"],"names":["runCompiler","generateStats","result","stat","errors","warnings","toJson","length","push","closeCompiler","compiler","Promise","resolve","reject","close","err","config","runWebpackSpan","run","stats","webpackCloseSpan","traceChild","traceAsyncFn","then","reason","toString","traceFn"],"mappings":";;;;QAqCgBA,WAAW,GAAXA,WAAW;AArCH,GAAoC,CAApC,QAAoC;SAQnDC,aAAa,CACpBC,MAAsB,EACtBC,IAAmB,EACH,CAAC;IACjB,KAAK,CAAC,CAAC,CAACC,MAAM,GAAEC,QAAQ,EAAC,CAAC,GAAGF,IAAI,CAACG,MAAM,CAAC,CAAiB;IAC1D,EAAE,EAAEF,MAAM,CAACG,MAAM,GAAG,CAAC,EAAE,CAAC;QACtBL,MAAM,CAACE,MAAM,CAACI,IAAI,IAAIJ,MAAM;IAC9B,CAAC;IAED,EAAE,EAAEC,QAAQ,CAACE,MAAM,GAAG,CAAC,EAAE,CAAC;QACxBL,MAAM,CAACG,QAAQ,CAACG,IAAI,IAAIH,QAAQ;IAClC,CAAC;IAED,MAAM,CAACH,MAAM;AACf,CAAC;AAED,EAAgE,AAAhE,8DAAgE;AAChE,EAAyG,AAAzG,uGAAyG;SAChGO,aAAa,CAACC,QAAkD,EAAE,CAAC;IAC1E,MAAM,CAAC,GAAG,CAACC,OAAO,EAAQC,OAAO,EAAEC,MAAM,GAAK,CAAC;QAC7C,EAAE,EAAE,CAAO,UAAIH,QAAQ,EAAE,CAAC;YACxB,EAA4D,AAA5D,0DAA4D;YAC5D,MAAM,CAACA,QAAQ,CAACI,KAAK,EAAEC,GAAQ,GAAMA,GAAG,GAAGF,MAAM,CAACE,GAAG,IAAIH,OAAO;;QAClE,CAAC;QAEDA,OAAO;IACT,CAAC;AACH,CAAC;SAEeZ,WAAW,CACzBgB,MAA6B,EAC7B,CAAC,CAACC,cAAc,EAA2B,CAAC,EACnB,CAAC;IAC1B,MAAM,CAAC,GAAG,CAACN,OAAO,EAAEC,OAAO,EAAEC,MAAM,GAAK,CAAC;QACvC,KAAK,CAACH,QAAQ,OA1CM,QAAoC,UA0C/BM,MAAM;QAC/BN,QAAQ,CAACQ,GAAG,EAAEH,GAAU,EAAEI,KAAoB,GAAK,CAAC;YAClD,KAAK,CAACC,gBAAgB,GAAGH,cAAc,CAACI,UAAU,CAAC,CAAe;YAClED,gBAAgB,CACbE,YAAY,KAAOb,aAAa,CAACC,QAAQ;cACzCa,IAAI,KAAO,CAAC;gBACX,EAAE,EAAER,GAAG,EAAE,CAAC;oBACR,KAAK,CAACS,MAAM,GAAGT,GAAG,aAAHA,GAAG,KAAHA,IAAI,CAAJA,CAAa,GAAbA,IAAI,CAAJA,CAAa,GAAbA,GAAG,CAAEU,QAAQ;oBAC5B,EAAE,EAAED,MAAM,EAAE,CAAC;wBACX,MAAM,CAACZ,OAAO,CAAC,CAAC;4BAACR,MAAM,EAAE,CAACoB;gCAAAA,MAAM;4BAAA,CAAC;4BAAEnB,QAAQ,EAAE,CAAC,CAAC;wBAAC,CAAC;oBACnD,CAAC;oBACD,MAAM,CAACQ,MAAM,CAACE,GAAG;gBACnB,CAAC;gBAED,KAAK,CAACb,MAAM,GAAGkB,gBAAgB,CAC5BC,UAAU,CAAC,CAA8B,+BACzCK,OAAO,KAAOzB,aAAa,CAAC,CAAC;wBAACG,MAAM,EAAE,CAAC,CAAC;wBAAEC,QAAQ,EAAE,CAAC,CAAC;oBAAC,CAAC,EAAEc,KAAK;;gBAClE,MAAM,CAACP,OAAO,CAACV,MAAM;YACvB,CAAC;QACL,CAAC;IACH,CAAC;AACH,CAAC"}