{"version":3,"sources":["../../../build/profiler/profiler.js"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\n\nlet maybeInspector\ntry {\n  maybeInspector = require('inspector')\n} catch (e) {\n  console.log('Unable to CPU profile in < node 8.0')\n}\n\nclass Profiler {\n  constructor(inspector) {\n    this.session = undefined\n    this.inspector = inspector\n  }\n\n  hasSession() {\n    return this.session !== undefined\n  }\n\n  startProfiling() {\n    if (this.inspector === undefined) {\n      return Promise.resolve()\n    }\n\n    try {\n      this.session = new maybeInspector.Session()\n      this.session.connect()\n    } catch (_) {\n      this.session = undefined\n      return Promise.resolve()\n    }\n\n    return Promise.all([\n      this.sendCommand('Profiler.setSamplingInterval', {\n        interval: 100,\n      }),\n      this.sendCommand('Profiler.enable'),\n      this.sendCommand('Profiler.start'),\n    ])\n  }\n\n  sendCommand(method, params) {\n    if (this.hasSession()) {\n      return new Promise((resolve, reject) => {\n        return this.session.post(method, params, (err, sessionParams) => {\n          if (err !== null) {\n            reject(err)\n          } else {\n            resolve(sessionParams)\n          }\n        })\n      })\n    } else {\n      return Promise.resolve()\n    }\n  }\n\n  destroy() {\n    if (this.hasSession()) {\n      this.session.disconnect()\n    }\n\n    return Promise.resolve()\n  }\n\n  stopProfiling() {\n    return this.sendCommand('Profiler.stop')\n  }\n}\n\n// eslint-disable-next-line import/no-extraneous-dependencies\nconst { Tracer } = require('chrome-trace-event')\n\n/**\n * an object that wraps Tracer and Profiler with a counter\n * @typedef {Object} Trace\n * @property {Tracer} trace instance of Tracer\n * @property {number} counter Counter\n * @property {Profiler} profiler instance of Profiler\n * @property {Function} end the end function\n */\n\n/**\n * @param {string} outputPath The location where to write the log.\n * @returns {Trace} The trace object\n */\nexport const createTrace = (outputPath) => {\n  const trace = new Tracer({\n    noStream: true,\n  })\n  const profiler = new Profiler(maybeInspector)\n  if (/\\/|\\\\/.test(outputPath)) {\n    const dirPath = path.dirname(outputPath)\n    fs.mkdirSync(dirPath, { recursive: true })\n  }\n  const fsStream = fs.createWriteStream(outputPath)\n\n  let counter = 0\n\n  trace.pipe(fsStream)\n  // These are critical events that need to be inserted so that tools like\n  // chrome dev tools can load the profile.\n  trace.instantEvent({\n    name: 'TracingStartedInPage',\n    id: ++counter,\n    cat: ['disabled-by-default-devtools.timeline'],\n    args: {\n      data: {\n        sessionId: '-1',\n        page: '0xfff',\n        frames: [\n          {\n            frame: '0xfff',\n            url: 'webpack',\n            name: '',\n          },\n        ],\n      },\n    },\n  })\n\n  trace.instantEvent({\n    name: 'TracingStartedInBrowser',\n    id: ++counter,\n    cat: ['disabled-by-default-devtools.timeline'],\n    args: {\n      data: {\n        sessionId: '-1',\n      },\n    },\n  })\n\n  return {\n    trace,\n    counter,\n    profiler,\n    end: (callback) => {\n      // Wait until the write stream finishes.\n      fsStream.on('finish', () => {\n        callback()\n      })\n      // Tear down the readable trace stream.\n      trace.push(null)\n    },\n  }\n}\n"],"names":["maybeInspector","require","e","console","log","Profiler","inspector","session","undefined","hasSession","startProfiling","Promise","resolve","Session","connect","_","all","sendCommand","interval","method","params","reject","post","err","sessionParams","destroy","disconnect","stopProfiling","Tracer","createTrace","outputPath","trace","noStream","profiler","test","dirPath","dirname","mkdirSync","recursive","fsStream","createWriteStream","counter","pipe","instantEvent","name","id","cat","args","data","sessionId","page","frames","frame","url","end","callback","on","push"],"mappings":"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"}