{"version":3,"sources":["../../../../../build/webpack/loaders/next-serverless-loader/index.ts"],"sourcesContent":["import devalue from 'next/dist/compiled/devalue'\nimport escapeRegexp from 'next/dist/compiled/escape-string-regexp'\nimport { join } from 'path'\nimport { parse } from 'querystring'\nimport { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { API_ROUTE } from '../../../../lib/constants'\nimport { isDynamicRoute } from '../../../../shared/lib/router/utils'\nimport { __ApiPreviewProps } from '../../../../server/api-utils'\nimport {\n  BUILD_MANIFEST,\n  ROUTES_MANIFEST,\n  REACT_LOADABLE_MANIFEST,\n} from '../../../../shared/lib/constants'\n\nexport type ServerlessLoaderQuery = {\n  page: string\n  distDir: string\n  absolutePagePath: string\n  absoluteAppPath: string\n  absoluteDocumentPath: string\n  absoluteErrorPath: string\n  absolute404Path: string\n  buildId: string\n  assetPrefix: string\n  generateEtags: string\n  poweredByHeader: string\n  canonicalBase: string\n  basePath: string\n  runtimeConfig: string\n  previewProps: string\n  loadedEnvFiles: string\n  i18n: string\n}\n\nconst nextServerlessLoader: webpack.loader.Loader = function () {\n  const {\n    distDir,\n    absolutePagePath,\n    page,\n    buildId,\n    canonicalBase,\n    assetPrefix,\n    absoluteAppPath,\n    absoluteDocumentPath,\n    absoluteErrorPath,\n    absolute404Path,\n    generateEtags,\n    poweredByHeader,\n    basePath,\n    runtimeConfig,\n    previewProps,\n    loadedEnvFiles,\n    i18n,\n  }: ServerlessLoaderQuery =\n    typeof this.query === 'string' ? parse(this.query.substr(1)) : this.query\n\n  const buildManifest = join(distDir, BUILD_MANIFEST).replace(/\\\\/g, '/')\n  const reactLoadableManifest = join(distDir, REACT_LOADABLE_MANIFEST).replace(\n    /\\\\/g,\n    '/'\n  )\n  const routesManifest = join(distDir, ROUTES_MANIFEST).replace(/\\\\/g, '/')\n\n  const escapedBuildId = escapeRegexp(buildId)\n  const pageIsDynamicRoute = isDynamicRoute(page)\n\n  const encodedPreviewProps = devalue(\n    JSON.parse(previewProps) as __ApiPreviewProps\n  )\n\n  const envLoading = `\n      const { processEnv } = require('@next/env')\n      processEnv(${Buffer.from(loadedEnvFiles, 'base64').toString()})\n    `\n\n  const runtimeConfigImports = runtimeConfig\n    ? `\n        const { setConfig } = require('next/config')\n      `\n    : ''\n\n  const runtimeConfigSetter = runtimeConfig\n    ? `\n        const runtimeConfig = ${runtimeConfig}\n        setConfig(runtimeConfig)\n      `\n    : 'const runtimeConfig = {}'\n\n  if (page.match(API_ROUTE)) {\n    return `\n        ${envLoading}\n        ${runtimeConfigImports}\n        ${\n          /*\n            this needs to be called first so its available for any other imports\n          */\n          runtimeConfigSetter\n        }\n        import 'next/dist/server/node-polyfill-fetch'\n        import routesManifest from '${routesManifest}'\n\n        import { getApiHandler } from 'next/dist/build/webpack/loaders/next-serverless-loader/api-handler'\n\n        const combinedRewrites = Array.isArray(routesManifest.rewrites)\n          ? routesManifest.rewrites\n          : []\n\n        if (!Array.isArray(routesManifest.rewrites)) {\n          combinedRewrites.push(...routesManifest.rewrites.beforeFiles)\n          combinedRewrites.push(...routesManifest.rewrites.afterFiles)\n          combinedRewrites.push(...routesManifest.rewrites.fallback)\n        }\n\n        const apiHandler = getApiHandler({\n          pageModule: require(\"${absolutePagePath}\"),\n          rewrites: combinedRewrites,\n          i18n: ${i18n || 'undefined'},\n          page: \"${page}\",\n          basePath: \"${basePath}\",\n          pageIsDynamic: ${pageIsDynamicRoute},\n          encodedPreviewProps: ${encodedPreviewProps}\n        })\n        export default apiHandler\n      `\n  } else {\n    return `\n      import 'next/dist/server/node-polyfill-fetch'\n      import routesManifest from '${routesManifest}'\n      import buildManifest from '${buildManifest}'\n      import reactLoadableManifest from '${reactLoadableManifest}'\n\n      ${envLoading}\n      ${runtimeConfigImports}\n      ${\n        // this needs to be called first so its available for any other imports\n        runtimeConfigSetter\n      }\n      import { getPageHandler } from 'next/dist/build/webpack/loaders/next-serverless-loader/page-handler'\n\n      const documentModule = require(\"${absoluteDocumentPath}\")\n\n      const appMod = require('${absoluteAppPath}')\n      let App = appMod.default || appMod.then && appMod.then(mod => mod.default);\n\n      const compMod = require('${absolutePagePath}')\n\n      const Component = compMod.default || compMod.then && compMod.then(mod => mod.default)\n      export default Component\n      export const getStaticProps = compMod['getStaticProp' + 's'] || compMod.then && compMod.then(mod => mod['getStaticProp' + 's'])\n      export const getStaticPaths = compMod['getStaticPath' + 's'] || compMod.then && compMod.then(mod => mod['getStaticPath' + 's'])\n      export const getServerSideProps = compMod['getServerSideProp' + 's'] || compMod.then && compMod.then(mod => mod['getServerSideProp' + 's'])\n\n      // kept for detecting legacy exports\n      export const unstable_getStaticParams = compMod['unstable_getStaticParam' + 's'] || compMod.then && compMod.then(mod => mod['unstable_getStaticParam' + 's'])\n      export const unstable_getStaticProps = compMod['unstable_getStaticProp' + 's'] || compMod.then && compMod.then(mod => mod['unstable_getStaticProp' + 's'])\n      export const unstable_getStaticPaths = compMod['unstable_getStaticPath' + 's'] || compMod.then && compMod.then(mod => mod['unstable_getStaticPath' + 's'])\n      export const unstable_getServerProps = compMod['unstable_getServerProp' + 's'] || compMod.then && compMod.then(mod => mod['unstable_getServerProp' + 's'])\n\n      export let config = compMod['confi' + 'g'] || (compMod.then && compMod.then(mod => mod['confi' + 'g'])) || {}\n      export const _app = App\n\n      const combinedRewrites = Array.isArray(routesManifest.rewrites)\n        ? routesManifest.rewrites\n        : []\n\n      if (!Array.isArray(routesManifest.rewrites)) {\n        combinedRewrites.push(...routesManifest.rewrites.beforeFiles)\n        combinedRewrites.push(...routesManifest.rewrites.afterFiles)\n        combinedRewrites.push(...routesManifest.rewrites.fallback)\n      }\n\n      const { renderReqToHTML, render } = getPageHandler({\n        pageModule: compMod,\n        pageComponent: Component,\n        pageConfig: config,\n        appModule: App,\n        documentModule: documentModule,\n        errorModule: require(\"${absoluteErrorPath}\"),\n        notFoundModule: ${\n          absolute404Path ? `require(\"${absolute404Path}\")` : undefined\n        },\n        pageGetStaticProps: getStaticProps,\n        pageGetStaticPaths: getStaticPaths,\n        pageGetServerSideProps: getServerSideProps,\n\n        assetPrefix: \"${assetPrefix}\",\n        canonicalBase: \"${canonicalBase}\",\n        generateEtags: ${generateEtags || 'false'},\n        poweredByHeader: ${poweredByHeader || 'false'},\n\n        runtimeConfig,\n        buildManifest,\n        reactLoadableManifest,\n\n        rewrites: combinedRewrites,\n        i18n: ${i18n || 'undefined'},\n        page: \"${page}\",\n        buildId: \"${buildId}\",\n        escapedBuildId: \"${escapedBuildId}\",\n        basePath: \"${basePath}\",\n        pageIsDynamic: ${pageIsDynamicRoute},\n        encodedPreviewProps: ${encodedPreviewProps}\n      })\n      export { renderReqToHTML, render }\n    `\n  }\n}\n\nexport default nextServerlessLoader\n"],"names":["nextServerlessLoader","distDir","absolutePagePath","page","buildId","canonicalBase","assetPrefix","absoluteAppPath","absoluteDocumentPath","absoluteErrorPath","absolute404Path","generateEtags","poweredByHeader","basePath","runtimeConfig","previewProps","loadedEnvFiles","i18n","query","substr","buildManifest","replace","reactLoadableManifest","routesManifest","escapedBuildId","pageIsDynamicRoute","encodedPreviewProps","JSON","parse","envLoading","Buffer","from","toString","runtimeConfigImports","runtimeConfigSetter","match","undefined"],"mappings":"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"}