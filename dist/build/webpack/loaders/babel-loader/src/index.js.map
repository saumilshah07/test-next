{"version":3,"sources":["../../../../../../build/webpack/loaders/babel-loader/src/index.js"],"sourcesContent":["// import babel from 'next/dist/compiled/babel/core'\nimport loaderUtils from 'next/dist/compiled/loader-utils'\nimport { trace } from '../../../../../telemetry/trace'\nimport cache from './cache'\nimport transform from './transform'\n\n// When using `import` Babel will be undefined\nconst babel = require('next/dist/compiled/babel/core')\n\nexport default function makeLoader(callback) {\n  const overrides = callback(babel)\n\n  return function (source, inputSourceMap) {\n    // Make the loader async\n    const cb = this.async()\n\n    loader.call(this, source, inputSourceMap, overrides).then(\n      (args) => cb(null, ...args),\n      (err) => cb(err)\n    )\n  }\n}\n\nasync function loader(source, inputSourceMap, overrides) {\n  // this.currentTraceSpan is provided by profiling-plugin.ts\n  const loaderSpan = trace('babel-loader', this.currentTraceSpan?.id)\n\n  return loaderSpan.traceAsyncFn(async () => {\n    const filename = this.resourcePath\n    loaderSpan.setAttribute('filename', filename)\n\n    let loaderOptions = loaderUtils.getOptions(this) || {}\n\n    let customOptions\n    if (overrides && overrides.customOptions) {\n      const customoptionsSpan = trace('loader-overrides-customoptions')\n      const result = await customoptionsSpan.traceAsyncFn(\n        async () =>\n          await overrides.customOptions.call(this, loaderOptions, {\n            source,\n            map: inputSourceMap,\n          })\n      )\n      customOptions = result.custom\n      loaderOptions = result.loader\n    }\n\n    // Standardize on 'sourceMaps' as the key passed through to Webpack, so that\n    // users may safely use either one alongside our default use of\n    // 'this.sourceMap' below without getting error about conflicting aliases.\n    if (\n      Object.prototype.hasOwnProperty.call(loaderOptions, 'sourceMap') &&\n      !Object.prototype.hasOwnProperty.call(loaderOptions, 'sourceMaps')\n    ) {\n      loaderOptions = Object.assign({}, loaderOptions, {\n        sourceMaps: loaderOptions.sourceMap,\n      })\n      delete loaderOptions.sourceMap\n    }\n\n    const programmaticOptions = Object.assign({}, loaderOptions, {\n      filename,\n      inputSourceMap: inputSourceMap || undefined,\n\n      // Set the default sourcemap behavior based on Webpack's mapping flag,\n      // but allow users to override if they want.\n      sourceMaps:\n        loaderOptions.sourceMaps === undefined\n          ? this.sourceMap\n          : loaderOptions.sourceMaps,\n\n      // Ensure that Webpack will get a full absolute path in the sourcemap\n      // so that it can properly map the module back to its internal cached\n      // modules.\n      sourceFileName: filename,\n      caller: {\n        name: 'babel-loader',\n\n        // Provide plugins with insight into webpack target.\n        // https://github.com/babel/babel-loader/issues/787\n        target: this.target,\n\n        // Webpack >= 2 supports ESM and dynamic import.\n        supportsStaticESM: true,\n        supportsDynamicImport: true,\n\n        // Webpack 5 supports TLA behind a flag. We enable it by default\n        // for Babel, and then webpack will throw an error if the experimental\n        // flag isn't enabled.\n        supportsTopLevelAwait: true,\n        ...loaderOptions.caller,\n      },\n    })\n    // Remove loader related options\n    delete programmaticOptions.cacheDirectory\n    delete programmaticOptions.cacheIdentifier\n\n    const partialConfigSpan = trace('babel-load-partial-config-async')\n    const config = partialConfigSpan.traceFn(() => {\n      return babel.loadPartialConfig(programmaticOptions)\n    })\n\n    if (config) {\n      let options = config.options\n      if (overrides && overrides.config) {\n        const overridesSpan = trace('loader-overrides-config')\n        options = await overridesSpan.traceAsyncFn(\n          async () =>\n            await overrides.config.call(this, config, {\n              source,\n              map: inputSourceMap,\n              customOptions,\n            })\n        )\n      }\n\n      if (options.sourceMaps === 'inline') {\n        // Babel has this weird behavior where if you set \"inline\", we\n        // inline the sourcemap, and set 'result.map = null'. This results\n        // in bad behavior from Babel since the maps get put into the code,\n        // which Webpack does not expect, and because the map we return to\n        // Webpack is null, which is also bad. To avoid that, we override the\n        // behavior here so \"inline\" just behaves like 'true'.\n        options.sourceMaps = true\n      }\n\n      const { cacheDirectory, cacheIdentifier } = loaderOptions\n\n      let result\n      if (cacheDirectory) {\n        result = await cache({\n          source,\n          options,\n          cacheDirectory,\n          cacheIdentifier,\n          cacheCompression: false,\n        })\n      } else {\n        const transformSpan = trace('transform')\n        transformSpan.setAttribute('filename', filename)\n        transformSpan.setAttribute('cache', 'DISABLED')\n        result = await transformSpan.traceAsyncFn(async () => {\n          return transform(source, options)\n        })\n      }\n\n      // TODO: Babel should really provide the full list of config files that\n      // were used so that this can also handle files loaded with 'extends'.\n      if (typeof config.babelrc === 'string') {\n        this.addDependency(config.babelrc)\n      }\n\n      if (result) {\n        const { code, map } = result\n\n        return [code, map]\n      }\n    }\n\n    // If the file was ignored, pass through the original content.\n    return [source, inputSourceMap]\n  })\n}\n"],"names":["makeLoader","babel","require","callback","overrides","source","inputSourceMap","cb","async","loader","call","then","args","err","loaderSpan","currentTraceSpan","id","traceAsyncFn","filename","resourcePath","setAttribute","loaderOptions","getOptions","customOptions","customoptionsSpan","result","map","custom","Object","prototype","hasOwnProperty","assign","sourceMaps","sourceMap","programmaticOptions","undefined","sourceFileName","caller","name","target","supportsStaticESM","supportsDynamicImport","supportsTopLevelAwait","cacheDirectory","cacheIdentifier","partialConfigSpan","config","traceFn","loadPartialConfig","options","overridesSpan","cacheCompression","transformSpan","babelrc","addDependency","code"],"mappings":"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"}