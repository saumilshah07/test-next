{"version":3,"sources":["../../../../../../build/webpack/loaders/babel-loader/src/cache.js"],"sourcesContent":["import { createHash } from 'crypto'\nimport { trace } from '../../../../../telemetry/trace'\nimport transform from './transform'\nimport cacache from 'next/dist/compiled/cacache'\n\nasync function read(cacheDirectory, etag) {\n  const cachedResult = await trace('read-cache-file').traceAsyncFn(() =>\n    cacache.get(cacheDirectory, etag)\n  )\n  return JSON.parse(cachedResult.data)\n}\n\nfunction write(cacheDirectory, etag, data) {\n  return trace('write-cache-file').traceAsyncFn(() =>\n    cacache.put(cacheDirectory, etag, JSON.stringify(data))\n  )\n}\n\nconst etag = function (source, identifier, options) {\n  return trace('etag').traceFn(() => {\n    const hash = createHash('md4')\n\n    const contents = JSON.stringify({ source, options, identifier })\n\n    hash.update(contents)\n\n    return hash.digest('hex')\n  })\n}\n\nexport default async function handleCache(params) {\n  const span = trace('handle-cache')\n\n  return span.traceAsyncFn(async () => {\n    const { source, options = {}, cacheIdentifier, cacheDirectory } = params\n\n    const file = etag(source, cacheIdentifier)\n\n    try {\n      // No errors mean that the file was previously cached\n      // we just need to return it\n      const res = await read(cacheDirectory, file)\n      span.setAttribute('cache', res ? 'HIT' : 'MISS')\n      return res\n    } catch (err) {}\n\n    // Otherwise just transform the file\n    // return it to the user asap and write it in cache\n    const result = await trace('transform').traceAsyncFn(async () => {\n      return transform(source, options)\n    })\n\n    await write(cacheDirectory, file, result)\n\n    return result\n  })\n}\n"],"names":["handleCache","read","cacheDirectory","etag","cachedResult","traceAsyncFn","get","JSON","parse","data","write","put","stringify","source","identifier","options","traceFn","hash","contents","update","digest","params","span","cacheIdentifier","file","res","setAttribute","err","result"],"mappings":";;;;kBA8B8BA,WAAW;AA9Bd,GAAQ,CAAR,OAAQ;AACb,GAAgC,CAAhC,MAAgC;AAChC,GAAa,CAAb,UAAa;AACf,GAA4B,CAA5B,QAA4B;;;;;;eAEjCC,IAAI,CAACC,cAAc,EAAEC,IAAI,EAAE,CAAC;IACzC,KAAK,CAACC,YAAY,GAAG,KAAK,KALN,MAAgC,QAKnB,CAAiB,kBAAEC,YAAY,KAH9C,QAA4B,SAIpCC,GAAG,CAACJ,cAAc,EAAEC,IAAI;;IAElC,MAAM,CAACI,IAAI,CAACC,KAAK,CAACJ,YAAY,CAACK,IAAI;AACrC,CAAC;SAEQC,KAAK,CAACR,cAAc,EAAEC,IAAI,EAAEM,IAAI,EAAE,CAAC;IAC1C,MAAM,KAZc,MAAgC,QAYvC,CAAkB,mBAAEJ,YAAY,KAV3B,QAA4B,SAWpCM,GAAG,CAACT,cAAc,EAAEC,IAAI,EAAEI,IAAI,CAACK,SAAS,CAACH,IAAI;;AAEzD,CAAC;AAED,KAAK,CAACN,KAAI,GAAG,QAAQ,CAAEU,MAAM,EAAEC,UAAU,EAAEC,OAAO,EAAE,CAAC;IACnD,MAAM,KAlBc,MAAgC,QAkBvC,CAAM,OAAEC,OAAO,KAAO,CAAC;QAClC,KAAK,CAACC,IAAI,OApBa,OAAQ,aAoBP,CAAK;QAE7B,KAAK,CAACC,QAAQ,GAAGX,IAAI,CAACK,SAAS,CAAC,CAAC;YAACC,MAAM;YAAEE,OAAO;YAAED,UAAU;QAAC,CAAC;QAE/DG,IAAI,CAACE,MAAM,CAACD,QAAQ;QAEpB,MAAM,CAACD,IAAI,CAACG,MAAM,CAAC,CAAK;IAC1B,CAAC;AACH,CAAC;eAE6BpB,WAAW,CAACqB,MAAM,EAAE,CAAC;IACjD,KAAK,CAACC,IAAI,OA9BU,MAAgC,QA8BjC,CAAc;IAEjC,MAAM,CAACA,IAAI,CAACjB,YAAY,WAAa,CAAC;QACpC,KAAK,CAAC,CAAC,CAACQ,MAAM,GAAEE,OAAO,EAAG,CAAC;QAAA,CAAC,GAAEQ,eAAe,GAAErB,cAAc,EAAC,CAAC,GAAGmB,MAAM;QAExE,KAAK,CAACG,IAAI,GAAGrB,KAAI,CAACU,MAAM,EAAEU,eAAe;QAEzC,GAAG,CAAC,CAAC;YACH,EAAqD,AAArD,mDAAqD;YACrD,EAA4B,AAA5B,0BAA4B;YAC5B,KAAK,CAACE,GAAG,GAAG,KAAK,CAACxB,IAAI,CAACC,cAAc,EAAEsB,IAAI;YAC3CF,IAAI,CAACI,YAAY,CAAC,CAAO,QAAED,GAAG,GAAG,CAAK,OAAG,CAAM;YAC/C,MAAM,CAACA,GAAG;QACZ,CAAC,CAAC,KAAK,EAAEE,GAAG,EAAE,CAAC;QAAA,CAAC;QAEhB,EAAoC,AAApC,kCAAoC;QACpC,EAAmD,AAAnD,iDAAmD;QACnD,KAAK,CAACC,MAAM,GAAG,KAAK,KA/CF,MAAgC,QA+CvB,CAAW,YAAEvB,YAAY,WAAa,CAAC;YAChE,MAAM,KA/CU,UAAa,UA+CZQ,MAAM,EAAEE,OAAO;QAClC,CAAC;QAED,KAAK,CAACL,KAAK,CAACR,cAAc,EAAEsB,IAAI,EAAEI,MAAM;QAExC,MAAM,CAACA,MAAM;IACf,CAAC;AACH,CAAC"}