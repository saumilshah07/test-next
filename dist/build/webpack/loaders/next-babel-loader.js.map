{"version":3,"sources":["../../../../build/webpack/loaders/next-babel-loader.js"],"sourcesContent":["import { join } from 'path'\nimport * as Log from '../../output/log'\nimport babelLoader from './babel-loader/src/index'\n\n// increment 'p' to invalidate cache\n// eslint-disable-next-line no-useless-concat\nconst cacheKey = 'babel-cache-' + 'p' + '-'\nconst nextBabelPreset = require('../../babel/preset')\n\nconst customBabelLoader = babelLoader((babel) => {\n  const presetItem = babel.createConfigItem(nextBabelPreset, {\n    type: 'preset',\n  })\n  const applyCommonJs = babel.createConfigItem(\n    require('../../babel/plugins/commonjs'),\n    { type: 'plugin' }\n  )\n  const commonJsItem = babel.createConfigItem(\n    require('next/dist/compiled/babel/plugin-transform-modules-commonjs'),\n    { type: 'plugin' }\n  )\n\n  const configs = new Set()\n\n  return {\n    customOptions(opts) {\n      const custom = {\n        isServer: opts.isServer,\n        pagesDir: opts.pagesDir,\n        development: opts.development,\n        hasReactRefresh: opts.hasReactRefresh,\n        hasJsxRuntime: opts.hasJsxRuntime,\n      }\n      const filename = join(opts.cwd, 'noop.js')\n      const loader = Object.assign(\n        opts.cache\n          ? {\n              cacheDirectory: join(opts.distDir, 'cache', 'next-babel-loader'),\n              cacheIdentifier:\n                cacheKey +\n                (opts.isServer ? '-server' : '') +\n                '-new-polyfills' +\n                (opts.development ? '-development' : '-production') +\n                (opts.hasReactRefresh ? '-react-refresh' : '') +\n                (opts.hasJsxRuntime ? '-jsx-runtime' : '') +\n                JSON.stringify(\n                  babel.loadPartialConfig({\n                    filename,\n                    cwd: opts.cwd,\n                    sourceFileName: filename,\n                  }).options\n                ),\n            }\n          : {\n              cacheDirectory: false,\n            },\n        opts\n      )\n\n      delete loader.isServer\n      delete loader.cache\n      delete loader.distDir\n      delete loader.pagesDir\n      delete loader.development\n      delete loader.hasReactRefresh\n      delete loader.hasJsxRuntime\n      return { loader, custom }\n    },\n    config(\n      cfg,\n      {\n        source,\n        customOptions: {\n          isServer,\n          pagesDir,\n          development,\n          hasReactRefresh,\n          hasJsxRuntime,\n        },\n      }\n    ) {\n      const filename = this.resourcePath\n      const options = Object.assign({}, cfg.options)\n      const isPageFile = filename.startsWith(pagesDir)\n\n      if (cfg.hasFilesystemConfig()) {\n        for (const file of [cfg.babelrc, cfg.config]) {\n          // We only log for client compilation otherwise there will be double output\n          if (file && !isServer && !configs.has(file)) {\n            configs.add(file)\n            Log.info(`Using external babel configuration from ${file}`)\n          }\n        }\n      } else {\n        // Add our default preset if the no \"babelrc\" found.\n        options.presets = [...options.presets, presetItem]\n      }\n\n      options.caller.isServer = isServer\n      options.caller.isDev = development\n      options.caller.hasJsxRuntime = hasJsxRuntime\n      options.caller.pagesDir = pagesDir\n\n      const emitWarning = this.emitWarning.bind(this)\n      Object.defineProperty(options.caller, 'onWarning', {\n        enumerable: false,\n        writable: false,\n        value: (options.caller.onWarning = function (reason) {\n          if (!(reason instanceof Error)) {\n            reason = new Error(reason)\n          }\n          emitWarning(reason)\n        }),\n      })\n\n      options.plugins = options.plugins || []\n\n      if (hasReactRefresh) {\n        const reactRefreshPlugin = babel.createConfigItem(\n          [require('react-refresh/babel'), { skipEnvCheck: true }],\n          { type: 'plugin' }\n        )\n        options.plugins.unshift(reactRefreshPlugin)\n        if (!isServer) {\n          const noAnonymousDefaultExportPlugin = babel.createConfigItem(\n            [require('../../babel/plugins/no-anonymous-default-export'), {}],\n            { type: 'plugin' }\n          )\n          options.plugins.unshift(noAnonymousDefaultExportPlugin)\n        }\n      }\n\n      if (!isServer && isPageFile) {\n        const pageConfigPlugin = babel.createConfigItem(\n          [require('../../babel/plugins/next-page-config')],\n          { type: 'plugin' }\n        )\n        options.plugins.push(pageConfigPlugin)\n\n        const diallowExportAll = babel.createConfigItem(\n          [\n            require('../../babel/plugins/next-page-disallow-re-export-all-exports'),\n          ],\n          { type: 'plugin' }\n        )\n        options.plugins.push(diallowExportAll)\n      }\n\n      // If the file has `module.exports` we have to transpile commonjs because Babel adds `import` statements\n      // That break webpack, since webpack doesn't support combining commonjs and esmodules\n      if (source.indexOf('module.exports') !== -1) {\n        options.plugins.push(applyCommonJs)\n      }\n\n      options.plugins.push([\n        require.resolve('next/dist/compiled/babel/plugin-transform-define'),\n        {\n          'process.env.NODE_ENV': development ? 'development' : 'production',\n          'typeof window': isServer ? 'undefined' : 'object',\n          'process.browser': isServer ? false : true,\n        },\n        'next-js-transform-define-instance',\n      ])\n\n      if (isPageFile) {\n        if (!isServer) {\n          options.plugins.push([\n            require.resolve('../../babel/plugins/next-ssg-transform'),\n            {},\n          ])\n        }\n      }\n\n      // As shared/lib has stateful modules we have to transpile commonjs\n      options.overrides = [\n        ...(options.overrides || []),\n        {\n          test: [\n            /next[\\\\/]dist[\\\\/]shared[\\\\/]lib/,\n            /next[\\\\/]dist[\\\\/]client/,\n            /next[\\\\/]dist[\\\\/]pages/,\n          ],\n          plugins: [commonJsItem],\n        },\n      ]\n\n      return options\n    },\n  }\n})\n\nexport default customBabelLoader\n"],"names":["Log","cacheKey","nextBabelPreset","require","customBabelLoader","babel","presetItem","createConfigItem","type","applyCommonJs","commonJsItem","configs","Set","customOptions","opts","custom","isServer","pagesDir","development","hasReactRefresh","hasJsxRuntime","filename","cwd","loader","Object","assign","cache","cacheDirectory","distDir","cacheIdentifier","JSON","stringify","loadPartialConfig","sourceFileName","options","config","cfg","source","resourcePath","isPageFile","startsWith","hasFilesystemConfig","file","babelrc","has","add","info","presets","caller","isDev","emitWarning","bind","defineProperty","enumerable","writable","value","onWarning","reason","Error","plugins","reactRefreshPlugin","skipEnvCheck","unshift","noAnonymousDefaultExportPlugin","pageConfigPlugin","push","diallowExportAll","indexOf","resolve","overrides","test"],"mappings":"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"}