{"version":3,"sources":["../../../../../../build/webpack/plugins/webpack-conformance-plugin/checks/duplicate-polyfills-conformance-check.ts"],"sourcesContent":["// eslint-disable-next-line import/no-extraneous-dependencies\nimport { namedTypes } from 'ast-types'\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport { NodePath } from 'ast-types/lib/node-path'\nimport { types } from 'next/dist/compiled/recast'\nimport {\n  CONFORMANCE_ERROR_PREFIX,\n  CONFORMANCE_WARNING_PREFIX,\n} from '../constants'\nimport {\n  IConformanceTestResult,\n  IConformanceTestStatus,\n  IGetAstNodeResult,\n  IParsedModuleDetails,\n  IWebpackConformanceTest,\n} from '../TestInterface'\nimport {\n  isNodeCreatingScriptElement,\n  reducePropsToObject,\n} from '../utils/ast-utils'\nimport { getLocalFileName } from '../utils/file-utils'\n\nfunction getMessage(\n  property: string,\n  request: string,\n  isWarning: Boolean = false\n): string {\n  if (isWarning) {\n    return `${CONFORMANCE_WARNING_PREFIX}: Found a ${property} polyfill in ${getLocalFileName(\n      request\n    )}.`\n  }\n  return `${CONFORMANCE_ERROR_PREFIX}: Found a ${property} polyfill in ${getLocalFileName(\n    request\n  )}.`\n}\n\nexport interface DuplicatePolyfillsConformanceTestSettings {\n  BlockedAPIToBePolyfilled?: string[]\n}\n\nconst BANNED_LEFT_OBJECT_TYPES = ['Identifier', 'ThisExpression']\n\nexport class DuplicatePolyfillsConformanceCheck\n  implements IWebpackConformanceTest\n{\n  private BlockedAPIs: string[] = []\n  constructor(options: DuplicatePolyfillsConformanceTestSettings = {}) {\n    this.BlockedAPIs = options.BlockedAPIToBePolyfilled || []\n  }\n  public getAstNode(): IGetAstNodeResult[] {\n    const EARLY_EXIT_SUCCESS_RESULT: IConformanceTestResult = {\n      result: IConformanceTestStatus.SUCCESS,\n    }\n    return [\n      {\n        visitor: 'visitAssignmentExpression',\n        inspectNode: (\n          path: NodePath<namedTypes.AssignmentExpression>,\n          { request }: IParsedModuleDetails\n        ): IConformanceTestResult => {\n          const { node } = path\n          const left = node.left as namedTypes.MemberExpression\n          /**\n           * We're only interested in code like `foo.fetch = bar;`.\n           * For anything else we exit with a success.\n           * Also foo in foo.bar needs to be either Identifier or `this` and not someFunction().fetch;\n           */\n          if (\n            left.type !== 'MemberExpression' ||\n            !BANNED_LEFT_OBJECT_TYPES.includes(left.object.type) ||\n            left.property.type !== 'Identifier'\n          ) {\n            return EARLY_EXIT_SUCCESS_RESULT\n          }\n          if (!this.BlockedAPIs.includes(left.property.name)) {\n            return EARLY_EXIT_SUCCESS_RESULT\n          }\n          /**\n           * Here we know the code is `foo.(fetch/URL) = something.\n           * If foo === this/self, fail it immediately.\n           * check for this.[fetch|URL(...BlockedAPIs)]/ self.[fetch|URL(...BlockedAPIs)]\n           **/\n          if (isNodeThisOrSelf(left.object)) {\n            return {\n              result: IConformanceTestStatus.FAILED,\n              warnings: [\n                {\n                  message: getMessage(left.property.name, request),\n                },\n              ],\n            }\n          }\n          /**\n           * we now are sure the code under examination is\n           * `globalVar.[fetch|URL(...BlockedAPIs)] = something`\n           **/\n          const objectName = (left.object as namedTypes.Identifier).name\n          const allBindings = path.scope.lookup(objectName)\n          if (!allBindings) {\n            /**\n             * we have absolutely no idea where globalVar came from,\n             * so lets just exit\n             **/\n            return EARLY_EXIT_SUCCESS_RESULT\n          }\n\n          try {\n            const sourcePath = allBindings.bindings[objectName][0]\n            const originPath = sourcePath.parentPath\n            const {\n              node: originNode,\n            }: { node: namedTypes.VariableDeclarator } = originPath\n            if (\n              originNode.type === 'VariableDeclarator' &&\n              isNodeThisOrSelf(originNode.init)\n            ) {\n              return {\n                result: IConformanceTestStatus.FAILED,\n                warnings: [\n                  {\n                    message: getMessage(left.property.name, request),\n                  },\n                ],\n              }\n            }\n            if (\n              originPath.name === 'params' &&\n              originPath.parentPath.firstInStatement()\n            ) {\n              /**\n               * We do not know what will be the value of this param at runtime so we just throw a warning.\n               * ```\n               * (function(scope){\n               *  ....\n               *  scope.fetch = new Fetch();\n               * })(.....)\n               * ```\n               */\n              return {\n                result: IConformanceTestStatus.FAILED,\n                warnings: [\n                  {\n                    message: getMessage(left.property.name, request, true),\n                  },\n                ],\n              }\n            }\n          } catch (e) {\n            return EARLY_EXIT_SUCCESS_RESULT\n          }\n\n          return EARLY_EXIT_SUCCESS_RESULT\n        },\n      },\n      {\n        visitor: 'visitCallExpression',\n        inspectNode: (path: NodePath) => {\n          const { node }: { node: types.namedTypes.CallExpression } = path\n          if (!node.arguments || node.arguments.length < 2) {\n            return EARLY_EXIT_SUCCESS_RESULT\n          }\n          if (isNodeCreatingScriptElement(node)) {\n            const propsNode = node\n              .arguments[1] as types.namedTypes.ObjectExpression\n            if (!propsNode.properties) {\n              return EARLY_EXIT_SUCCESS_RESULT\n            }\n            const props: {\n              [key: string]: string\n            } = reducePropsToObject(propsNode)\n            if (!('src' in props)) {\n              return EARLY_EXIT_SUCCESS_RESULT\n            }\n            const foundBannedPolyfill = doesScriptLoadBannedAPIfromPolyfillIO(\n              props.src,\n              this.BlockedAPIs\n            )\n            if (foundBannedPolyfill) {\n              return {\n                result: IConformanceTestStatus.FAILED,\n                warnings: [\n                  {\n                    message: `${CONFORMANCE_WARNING_PREFIX}: Found polyfill.io loading polyfill for ${foundBannedPolyfill}.`,\n                  },\n                ],\n              }\n            }\n          }\n          return EARLY_EXIT_SUCCESS_RESULT\n        },\n      },\n    ]\n  }\n}\n\nfunction isNodeThisOrSelf(node: any): boolean {\n  return (\n    node.type === 'ThisExpression' ||\n    (node.type === 'Identifier' && node.name === 'self')\n  )\n}\n\nfunction doesScriptLoadBannedAPIfromPolyfillIO(\n  source: string,\n  blockedAPIs: string[]\n): string | undefined {\n  const url = new URL(source)\n  if (url.hostname === 'polyfill.io' && url.searchParams.has('features')) {\n    const requestedAPIs = (url.searchParams.get('features') || '').split(',')\n    return blockedAPIs.find((api) => requestedAPIs.includes(api))\n  }\n}\n"],"names":["getMessage","property","request","isWarning","BANNED_LEFT_OBJECT_TYPES","DuplicatePolyfillsConformanceCheck","options","BlockedAPIs","BlockedAPIToBePolyfilled","getAstNode","EARLY_EXIT_SUCCESS_RESULT","result","SUCCESS","visitor","inspectNode","path","node","left","type","includes","object","name","isNodeThisOrSelf","FAILED","warnings","message","objectName","allBindings","scope","lookup","sourcePath","bindings","originPath","parentPath","originNode","init","firstInStatement","e","arguments","length","propsNode","properties","props","foundBannedPolyfill","doesScriptLoadBannedAPIfromPolyfillIO","src","source","blockedAPIs","url","URL","hostname","searchParams","has","requestedAPIs","get","split","find","api"],"mappings":"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"}