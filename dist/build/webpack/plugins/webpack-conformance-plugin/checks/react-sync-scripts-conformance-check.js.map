{"version":3,"sources":["../../../../../../build/webpack/plugins/webpack-conformance-plugin/checks/react-sync-scripts-conformance-check.ts"],"sourcesContent":["import {\n  IWebpackConformanceTest,\n  IGetAstNodeResult,\n  IParsedModuleDetails,\n  IConformanceTestResult,\n  IConformanceTestStatus,\n} from '../TestInterface'\nimport {\n  CONFORMANCE_ERROR_PREFIX,\n  CONFORMANCE_WARNING_PREFIX,\n} from '../constants'\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport { namedTypes } from 'ast-types/'\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport { NodePath } from 'ast-types/lib/node-path'\nimport { getLocalFileName } from '../utils/file-utils'\nimport { isNodeCreatingScriptElement } from '../utils/ast-utils'\nexport const ErrorMessage: string = `${CONFORMANCE_ERROR_PREFIX}: A sync script was found in a react module.`\nexport const WarningMessage: string = `${CONFORMANCE_WARNING_PREFIX}: A sync script was found in a react module.`\nexport const ErrorDescription = ``\nconst EARLY_EXIT_SUCCESS_RESULT: IConformanceTestResult = {\n  result: IConformanceTestStatus.SUCCESS,\n}\n\nexport interface ReactSyncScriptsConformanceCheckOptions {\n  AllowedSources?: String[]\n}\nexport class ReactSyncScriptsConformanceCheck\n  implements IWebpackConformanceTest\n{\n  private allowedSources: String[] = []\n  constructor({\n    AllowedSources,\n  }: ReactSyncScriptsConformanceCheckOptions = {}) {\n    if (AllowedSources) {\n      this.allowedSources = AllowedSources\n    }\n  }\n\n  public getAstNode(): IGetAstNodeResult[] {\n    return [\n      {\n        visitor: 'visitCallExpression',\n        inspectNode: (path: NodePath, { request }: IParsedModuleDetails) => {\n          const { node }: { node: namedTypes.CallExpression } = path\n          if (!node.arguments || node.arguments.length < 2) {\n            return EARLY_EXIT_SUCCESS_RESULT\n          }\n          if (isNodeCreatingScriptElement(node)) {\n            const propsNode = node.arguments[1] as namedTypes.ObjectExpression\n            if (!propsNode.properties) {\n              return EARLY_EXIT_SUCCESS_RESULT\n            }\n            const props: {\n              [key: string]: string\n            } = propsNode.properties.reduce((originalProps, prop: any) => {\n              // @ts-ignore\n              originalProps[prop.key.name] = prop.value.value\n              return originalProps\n            }, {})\n            if (\n              'defer' in props ||\n              'async' in props ||\n              !('src' in props) ||\n              this.allowedSources.includes(props.src)\n            ) {\n              return EARLY_EXIT_SUCCESS_RESULT\n            }\n\n            // Todo: Add an absolute error case for modern js when class is a subclass of next/head.\n            return {\n              result: IConformanceTestStatus.FAILED,\n              warnings: [\n                {\n                  message: `${WarningMessage} ${getLocalFileName(\n                    request\n                  )}. This can potentially delay FCP/FP metrics.`,\n                },\n              ],\n            }\n          }\n          return EARLY_EXIT_SUCCESS_RESULT\n        },\n      },\n    ]\n  }\n}\n"],"names":["ErrorMessage","WarningMessage","ErrorDescription","EARLY_EXIT_SUCCESS_RESULT","result","SUCCESS","ReactSyncScriptsConformanceCheck","AllowedSources","allowedSources","getAstNode","visitor","inspectNode","path","request","node","arguments","length","propsNode","properties","props","reduce","originalProps","prop","key","name","value","includes","src","FAILED","warnings","message"],"mappings":";;;;;AAMO,GAAkB,CAAlB,cAAkB;AAIlB,GAAc,CAAd,UAAc;AAKY,GAAqB,CAArB,UAAqB;AACV,GAAoB,CAApB,SAAoB;AACzD,KAAK,CAACA,YAAY,MAPlB,UAAc,0BAO2C,4CAA4C;QAA/FA,YAAY,GAAZA,YAAY;AAClB,KAAK,CAACC,cAAc,MARpB,UAAc,4BAQ+C,4CAA4C;QAAnGA,cAAc,GAAdA,cAAc;AACpB,KAAK,CAACC,gBAAgB;QAAhBA,gBAAgB,GAAhBA,gBAAgB;AAC7B,KAAK,CAACC,yBAAyB,GAA2B,CAAC;IACzDC,MAAM,EAfD,cAAkB,wBAeQC,OAAO;AACxC,CAAC;MAKYC,gCAAgC;gBAI/B,CAAC,CACXC,cAAc,EACyB,CAAC,GAAG,CAAC;IAAA,CAAC,CAAE,CAAC;QAN7C,IA2DN,CAxDSC,cAAc,GAAa,CAAC,CAAC;QAInC,EAAE,EAAED,cAAc,EAAE,CAAC;YACnB,IAAI,CAACC,cAAc,GAAGD,cAAc;QACtC,CAAC;IACH,CAAC;IAEME,UAAU,GAAwB,CAAC;QACxC,MAAM,CAAC,CAAC;YACN,CAAC;gBACCC,OAAO,EAAE,CAAqB;gBAC9BC,WAAW,GAAGC,IAAc,EAAE,CAAC,CAACC,OAAO,EAAuB,CAAC,GAAK,CAAC;oBACnE,KAAK,CAAC,CAAC,CAACC,IAAI,EAAC,CAAC,GAAwCF,IAAI;oBAC1D,EAAE,GAAGE,IAAI,CAACC,SAAS,IAAID,IAAI,CAACC,SAAS,CAACC,MAAM,GAAG,CAAC,EAAE,CAAC;wBACjD,MAAM,CAACb,yBAAyB;oBAClC,CAAC;oBACD,EAAE,MAhCgC,SAAoB,8BAgCtBW,IAAI,GAAG,CAAC;wBACtC,KAAK,CAACG,SAAS,GAAGH,IAAI,CAACC,SAAS,CAAC,CAAC;wBAClC,EAAE,GAAGE,SAAS,CAACC,UAAU,EAAE,CAAC;4BAC1B,MAAM,CAACf,yBAAyB;wBAClC,CAAC;wBACD,KAAK,CAACgB,KAAK,GAEPF,SAAS,CAACC,UAAU,CAACE,MAAM,EAAEC,aAAa,EAAEC,IAAS,GAAK,CAAC;4BAC7D,EAAa,AAAb,WAAa;4BACbD,aAAa,CAACC,IAAI,CAACC,GAAG,CAACC,IAAI,IAAIF,IAAI,CAACG,KAAK,CAACA,KAAK;4BAC/C,MAAM,CAACJ,aAAa;wBACtB,CAAC,EAAE,CAAC;wBAAA,CAAC;wBACL,EAAE,EACA,CAAO,UAAIF,KAAK,IAChB,CAAO,UAAIA,KAAK,MACd,CAAK,QAAIA,KAAK,KAChB,IAAI,CAACX,cAAc,CAACkB,QAAQ,CAACP,KAAK,CAACQ,GAAG,GACtC,CAAC;4BACD,MAAM,CAACxB,yBAAyB;wBAClC,CAAC;wBAED,EAAwF,AAAxF,sFAAwF;wBACxF,MAAM,CAAC,CAAC;4BACNC,MAAM,EAjEb,cAAkB,wBAiEoBwB,MAAM;4BACrCC,QAAQ,EAAE,CAAC;gCACT,CAAC;oCACCC,OAAO,KAAK7B,cAAc,CAAC,CAAC,MA3Db,UAAqB,mBA4DlCY,OAAO,EACP,4CAA4C;gCAChD,CAAC;4BACH,CAAC;wBACH,CAAC;oBACH,CAAC;oBACD,MAAM,CAACV,yBAAyB;gBAClC,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;;QA1DUG,gCAAgC,GAAhCA,gCAAgC"}