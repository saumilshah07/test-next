{"version":3,"sources":["../../../../build/webpack/plugins/nextjs-ssr-module-cache.ts"],"sourcesContent":["import { webpack, sources } from 'next/dist/compiled/webpack/webpack'\nimport { join, relative, dirname } from 'path'\nimport getRouteFromEntrypoint from '../../../server/get-route-from-entrypoint'\nconst SSR_MODULE_CACHE_FILENAME = 'ssr-module-cache.js'\n\n// By default webpack keeps initialized modules per-module.\n// This means that if you have 2 entrypoints loaded into the same app\n// they will *not* share the same instance\n// This creates many issues when developers / libraries rely on the singleton pattern\n// As this pattern assumes every module will have 1 instance\n// This plugin overrides webpack's code generation step to replace `installedModules`\n// The replacement is a require for a file that's also generated here that only exports an empty object\n// Because of Node.js's single instance modules this makes webpack share all initialized instances\n// Do note that this module is only geared towards the `node` compilation target.\n// For the client side compilation we use `runtimeChunk: 'single'`\nexport default class NextJsSsrImportPlugin {\n  private options: { outputPath: string }\n\n  constructor(options: { outputPath: string }) {\n    this.options = options\n  }\n  apply(compiler: webpack.Compiler) {\n    const { outputPath } = this.options\n    compiler.hooks.emit.tapAsync(\n      'NextJsSSRModuleCache',\n      (compilation, callback) => {\n        compilation.assets[SSR_MODULE_CACHE_FILENAME] = new sources.RawSource(`\n      /* This cache is used by webpack for instantiated modules */\n      module.exports = {}\n      `)\n        callback()\n      }\n    )\n    compiler.hooks.compilation.tap(\n      'NextJsSSRModuleCache',\n      (compilation: any) => {\n        compilation.mainTemplate.hooks.localVars.intercept({\n          register(tapInfo: any) {\n            if (tapInfo.name === 'MainTemplate') {\n              const originalFn = tapInfo.fn\n              tapInfo.fn = (source: any, chunk: any) => {\n                // If the chunk is not part of the pages directory we have to keep the original behavior,\n                // otherwise webpack will error out when the file is used before the compilation finishes\n                // this is the case with mini-css-extract-plugin\n\n                if (!getRouteFromEntrypoint(chunk.name)) {\n                  return originalFn(source, chunk)\n                }\n                const pagePath = join(outputPath, dirname(chunk.name))\n                let relativePathToBaseDir = relative(\n                  pagePath,\n                  join(outputPath, SSR_MODULE_CACHE_FILENAME)\n                )\n\n                // Make sure even in windows, the path looks like in unix\n                // Node.js require system will convert it accordingly\n                const relativePathToBaseDirNormalized =\n                  relativePathToBaseDir.replace(/\\\\/g, '/')\n                return (webpack as any).Template.asString([\n                  source,\n                  '// The module cache',\n                  `var installedModules = require('${relativePathToBaseDirNormalized}');`,\n                ])\n              }\n            }\n            return tapInfo\n          },\n        })\n      }\n    )\n  }\n}\n"],"names":["SSR_MODULE_CACHE_FILENAME","NextJsSsrImportPlugin","options","apply","compiler","outputPath","hooks","emit","tapAsync","compilation","callback","assets","RawSource","tap","mainTemplate","localVars","intercept","register","tapInfo","name","originalFn","fn","source","chunk","pagePath","relativePathToBaseDir","relativePathToBaseDirNormalized","replace","Template","asString"],"mappings":";;;;;AAAiC,GAAoC,CAApC,QAAoC;AAC7B,GAAM,CAAN,KAAM;AACX,GAA2C,CAA3C,uBAA2C;;;;;;AAC9E,KAAK,CAACA,yBAAyB,GAAG,CAAqB;MAYlCC,qBAAqB;gBAG5BC,OAA+B,CAAE,CAAC;QAC5C,IAAI,CAACA,OAAO,GAAGA,OAAO;IACxB,CAAC;IACDC,KAAK,CAACC,QAA0B,EAAE,CAAC;QACjC,KAAK,CAAC,CAAC,CAACC,UAAU,EAAC,CAAC,GAAG,IAAI,CAACH,OAAO;QACnCE,QAAQ,CAACE,KAAK,CAACC,IAAI,CAACC,QAAQ,CAC1B,CAAsB,wBACrBC,WAAW,EAAEC,QAAQ,GAAK,CAAC;YAC1BD,WAAW,CAACE,MAAM,CAACX,yBAAyB,IAAI,GAAG,CA1B1B,QAAoC,SA0BDY,SAAS,EAAE,oGAGzE;YACEF,QAAQ;QACV,CAAC;QAEHN,QAAQ,CAACE,KAAK,CAACG,WAAW,CAACI,GAAG,CAC5B,CAAsB,wBACrBJ,WAAgB,GAAK,CAAC;YACrBA,WAAW,CAACK,YAAY,CAACR,KAAK,CAACS,SAAS,CAACC,SAAS,CAAC,CAAC;gBAClDC,QAAQ,EAACC,OAAY,EAAE,CAAC;oBACtB,EAAE,EAAEA,OAAO,CAACC,IAAI,KAAK,CAAc,eAAE,CAAC;wBACpC,KAAK,CAACC,UAAU,GAAGF,OAAO,CAACG,EAAE;wBAC7BH,OAAO,CAACG,EAAE,IAAIC,MAAW,EAAEC,KAAU,GAAK,CAAC;4BACzC,EAAyF,AAAzF,uFAAyF;4BACzF,EAAyF,AAAzF,uFAAyF;4BACzF,EAAgD,AAAhD,8CAAgD;4BAEhD,EAAE,OA3CiB,uBAA2C,UA2ClCA,KAAK,CAACJ,IAAI,GAAG,CAAC;gCACxC,MAAM,CAACC,UAAU,CAACE,MAAM,EAAEC,KAAK;4BACjC,CAAC;4BACD,KAAK,CAACC,QAAQ,OA/CU,KAAM,OA+CRnB,UAAU,MA/CR,KAAM,UA+CYkB,KAAK,CAACJ,IAAI;4BACpD,GAAG,CAACM,qBAAqB,OAhDD,KAAM,WAiD5BD,QAAQ,MAjDc,KAAM,OAkDvBnB,UAAU,EAAEL,yBAAyB;4BAG5C,EAAyD,AAAzD,uDAAyD;4BACzD,EAAqD,AAArD,mDAAqD;4BACrD,KAAK,CAAC0B,+BAA+B,GACnCD,qBAAqB,CAACE,OAAO,QAAQ,CAAG;4BAC1C,MAAM,CA1DW,QAAoC,SA0D7BC,QAAQ,CAACC,QAAQ,CAAC,CAAC;gCACzCP,MAAM;gCACN,CAAqB;iCACpB,gCAAgC,EAAEI,+BAA+B,CAAC,GAAG;4BACxE,CAAC;wBACH,CAAC;oBACH,CAAC;oBACD,MAAM,CAACR,OAAO;gBAChB,CAAC;YACH,CAAC;QACH,CAAC;IAEL,CAAC;;kBAvDkBjB,qBAAqB"}