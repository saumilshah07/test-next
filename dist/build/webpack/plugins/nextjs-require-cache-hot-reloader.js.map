{"version":3,"sources":["../../../../build/webpack/plugins/nextjs-require-cache-hot-reloader.ts"],"sourcesContent":["import { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { isWebpack5 } from 'next/dist/compiled/webpack/webpack'\nimport { realpathSync } from 'fs'\nimport path from 'path'\n\nconst originModules = [\n  require.resolve('../../../server/require'),\n  require.resolve('../../../server/load-components'),\n]\n\nfunction deleteCache(filePath: string) {\n  try {\n    filePath = realpathSync(filePath)\n  } catch (e) {\n    if (e.code !== 'ENOENT') throw e\n  }\n  const module = require.cache[filePath]\n  if (module) {\n    // remove the child reference from the originModules\n    for (const originModule of originModules) {\n      const parent = require.cache[originModule]\n      if (parent) {\n        const idx = parent.children.indexOf(module)\n        if (idx >= 0) parent.children.splice(idx, 1)\n      }\n    }\n    // remove parent references from external modules\n    for (const child of module.children) {\n      child.parent = null\n    }\n  }\n  delete require.cache[filePath]\n}\n\nconst PLUGIN_NAME = 'NextJsRequireCacheHotReloader'\n\n// This plugin flushes require.cache after emitting the files. Providing 'hot reloading' of server files.\nexport class NextJsRequireCacheHotReloader implements webpack.Plugin {\n  prevAssets: any = null\n  previousOutputPathsWebpack5: Set<string> = new Set()\n  currentOutputPathsWebpack5: Set<string> = new Set()\n\n  apply(compiler: webpack.Compiler) {\n    if (isWebpack5) {\n      // @ts-ignored Webpack has this hooks\n      compiler.hooks.assetEmitted.tap(\n        PLUGIN_NAME,\n        (_file: any, { targetPath }: any) => {\n          this.currentOutputPathsWebpack5.add(targetPath)\n          deleteCache(targetPath)\n        }\n      )\n\n      compiler.hooks.afterEmit.tap(PLUGIN_NAME, (compilation) => {\n        const runtimeChunkPath = path.join(\n          compilation.outputOptions.path,\n          'webpack-runtime.js'\n        )\n        deleteCache(runtimeChunkPath)\n\n        // we need to make sure to clear all server entries from cache\n        // since they can have a stale webpack-runtime cache\n        // which needs to always be in-sync\n        const entries = [...compilation.entries.keys()].filter((entry) =>\n          entry.toString().startsWith('pages/')\n        )\n\n        entries.forEach((page) => {\n          const outputPath = path.join(\n            compilation.outputOptions.path,\n            page + '.js'\n          )\n          deleteCache(outputPath)\n        })\n      })\n\n      this.previousOutputPathsWebpack5 = new Set(\n        this.currentOutputPathsWebpack5\n      )\n      this.currentOutputPathsWebpack5.clear()\n      return\n    }\n\n    compiler.hooks.afterEmit.tapAsync(PLUGIN_NAME, (compilation, callback) => {\n      const { assets } = compilation\n\n      if (this.prevAssets) {\n        for (const f of Object.keys(assets)) {\n          deleteCache(assets[f].existsAt)\n        }\n        for (const f of Object.keys(this.prevAssets)) {\n          if (!assets[f]) {\n            deleteCache(this.prevAssets[f].existsAt)\n          }\n        }\n      }\n      this.prevAssets = assets\n\n      callback()\n    })\n  }\n}\n"],"names":["originModules","require","resolve","deleteCache","filePath","e","code","module","cache","originModule","parent","idx","children","indexOf","splice","child","PLUGIN_NAME","NextJsRequireCacheHotReloader","apply","compiler","hooks","assetEmitted","tap","_file","targetPath","currentOutputPathsWebpack5","add","afterEmit","compilation","runtimeChunkPath","join","outputOptions","path","entries","keys","filter","entry","toString","startsWith","forEach","page","outputPath","previousOutputPathsWebpack5","Set","clear","tapAsync","callback","assets","prevAssets","f","Object","existsAt"],"mappings":"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"}