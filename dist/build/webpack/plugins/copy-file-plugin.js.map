{"version":3,"sources":["../../../../build/webpack/plugins/copy-file-plugin.ts"],"sourcesContent":["import { promises as fs } from 'fs'\nimport loaderUtils from 'next/dist/compiled/loader-utils'\nimport {\n  isWebpack5,\n  sources,\n  webpack,\n} from 'next/dist/compiled/webpack/webpack'\n\nconst PLUGIN_NAME = 'CopyFilePlugin'\n\nexport class CopyFilePlugin {\n  private filePath: string\n  private name: string\n  private cacheKey: string\n  private info?: object\n\n  constructor({\n    filePath,\n    cacheKey,\n    name,\n    info,\n  }: {\n    filePath: string\n    cacheKey: string\n    name: string\n    minimize: boolean\n    info?: object\n  }) {\n    this.filePath = filePath\n    this.cacheKey = cacheKey\n    this.name = name\n    this.info = info\n  }\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.thisCompilation.tap(PLUGIN_NAME, (compilation: any) => {\n      const cache = isWebpack5 ? compilation.getCache('CopyFilePlugin') : null\n      const hook = isWebpack5\n        ? // @ts-ignore\n          compilation.hooks.processAssets\n        : compilation.hooks.additionalAssets\n      hook.tapPromise(\n        isWebpack5\n          ? {\n              name: PLUGIN_NAME,\n              // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n              stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n            }\n          : PLUGIN_NAME,\n        async () => {\n          if (cache) {\n            const cachedResult = await cache.getPromise(\n              this.filePath,\n              this.cacheKey\n            )\n            if (cachedResult) {\n              const { file, source } = cachedResult\n              compilation.emitAsset(file, source, {\n                ...this.info,\n              })\n              return\n            }\n          }\n          const content = await fs.readFile(this.filePath, 'utf8')\n\n          const file = loaderUtils.interpolateName(\n            { resourcePath: this.filePath },\n            this.name,\n            { content, context: compiler.context }\n          )\n\n          const source = new sources.RawSource(content)\n\n          if (cache) {\n            await cache.storePromise(this.filePath, this.cacheKey, {\n              file,\n              source,\n            })\n          }\n\n          // @ts-ignore\n          compilation.emitAsset(file, source, {\n            ...this.info,\n          })\n        }\n      )\n    })\n  }\n}\n"],"names":["PLUGIN_NAME","CopyFilePlugin","filePath","cacheKey","name","info","apply","compiler","hooks","thisCompilation","tap","compilation","cache","getCache","hook","processAssets","additionalAssets","tapPromise","stage","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS","cachedResult","getPromise","file","source","emitAsset","content","readFile","interpolateName","resourcePath","context","RawSource","storePromise"],"mappings":";;;;AAA+B,GAAI,CAAJ,GAAI;AACX,GAAiC,CAAjC,YAAiC;AAKlD,GAAoC,CAApC,QAAoC;;;;;;AAE3C,KAAK,CAACA,WAAW,GAAG,CAAgB;MAEvBC,cAAc;gBAMb,CAAC,CACXC,QAAQ,GACRC,QAAQ,GACRC,IAAI,GACJC,IAAI,EAON,CAAC,CAAE,CAAC;QACF,IAAI,CAACH,QAAQ,GAAGA,QAAQ;QACxB,IAAI,CAACC,QAAQ,GAAGA,QAAQ;QACxB,IAAI,CAACC,IAAI,GAAGA,IAAI;QAChB,IAAI,CAACC,IAAI,GAAGA,IAAI;IAClB,CAAC;IAEDC,KAAK,CAACC,QAA0B,EAAE,CAAC;QACjCA,QAAQ,CAACC,KAAK,CAACC,eAAe,CAACC,GAAG,CAACV,WAAW,GAAGW,WAAgB,GAAK,CAAC;YACrE,KAAK,CAACC,KAAK,GA9BV,QAAoC,cA8BVD,WAAW,CAACE,QAAQ,CAAC,CAAgB,mBAAI,IAAI;YACxE,KAAK,CAACC,IAAI,GA/BT,QAAoC,cAiCjCH,WAAW,CAACH,KAAK,CAACO,aAAa,GAC/BJ,WAAW,CAACH,KAAK,CAACQ,gBAAgB;YACtCF,IAAI,CAACG,UAAU,CAnCd,QAAoC,cAqC/B,CAAC;gBACCb,IAAI,EAAEJ,WAAW;gBACjB,EAA0D,AAA1D,wDAA0D;gBAC1DkB,KAAK,EAxCZ,QAAoC,SAwCdC,WAAW,CAACC,8BAA8B;YAC3D,CAAC,GACDpB,WAAW,YACH,CAAC;gBACX,EAAE,EAAEY,KAAK,EAAE,CAAC;oBACV,KAAK,CAACS,YAAY,GAAG,KAAK,CAACT,KAAK,CAACU,UAAU,CACzC,IAAI,CAACpB,QAAQ,EACb,IAAI,CAACC,QAAQ;oBAEf,EAAE,EAAEkB,YAAY,EAAE,CAAC;wBACjB,KAAK,CAAC,CAAC,CAACE,IAAI,GAAEC,MAAM,EAAC,CAAC,GAAGH,YAAY;wBACrCV,WAAW,CAACc,SAAS,CAACF,IAAI,EAAEC,MAAM,EAAE,CAAC;+BAChC,IAAI,CAACnB,IAAI;wBACd,CAAC;wBACD,MAAM;oBACR,CAAC;gBACH,CAAC;gBACD,KAAK,CAACqB,OAAO,GAAG,KAAK,CA/DA,GAAI,UA+DAC,QAAQ,CAAC,IAAI,CAACzB,QAAQ,EAAE,CAAM;gBAEvD,KAAK,CAACqB,IAAI,GAhEI,YAAiC,SAgEtBK,eAAe,CACtC,CAAC;oBAACC,YAAY,EAAE,IAAI,CAAC3B,QAAQ;gBAAC,CAAC,EAC/B,IAAI,CAACE,IAAI,EACT,CAAC;oBAACsB,OAAO;oBAAEI,OAAO,EAAEvB,QAAQ,CAACuB,OAAO;gBAAC,CAAC;gBAGxC,KAAK,CAACN,MAAM,GAAG,GAAG,CAjErB,QAAoC,SAiENO,SAAS,CAACL,OAAO;gBAE5C,EAAE,EAAEd,KAAK,EAAE,CAAC;oBACV,KAAK,CAACA,KAAK,CAACoB,YAAY,CAAC,IAAI,CAAC9B,QAAQ,EAAE,IAAI,CAACC,QAAQ,EAAE,CAAC;wBACtDoB,IAAI;wBACJC,MAAM;oBACR,CAAC;gBACH,CAAC;gBAED,EAAa,AAAb,WAAa;gBACbb,WAAW,CAACc,SAAS,CAACF,IAAI,EAAEC,MAAM,EAAE,CAAC;uBAChC,IAAI,CAACnB,IAAI;gBACd,CAAC;YACH,CAAC;QAEL,CAAC;IACH,CAAC;;QA7EUJ,cAAc,GAAdA,cAAc"}