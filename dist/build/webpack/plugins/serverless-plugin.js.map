{"version":3,"sources":["../../../../build/webpack/plugins/serverless-plugin.ts"],"sourcesContent":["import { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { isWebpack5, GraphHelpers } from 'next/dist/compiled/webpack/webpack'\n\n/**\n * Makes sure there are no dynamic chunks when the target is serverless\n * The dynamic chunks are integrated back into their parent chunk\n * This is to make sure there is a single render bundle instead of that bundle importing dynamic chunks\n */\n\nexport class ServerlessPlugin {\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.compilation.tap('ServerlessPlugin', (compilation) => {\n      const hook = isWebpack5\n        ? compilation.hooks.optimizeChunks\n        : compilation.hooks.optimizeChunksBasic\n\n      hook.tap('ServerlessPlugin', (chunks) => {\n        for (const chunk of chunks) {\n          // If chunk is not an entry point skip them\n          if (!chunk.hasEntryModule()) {\n            continue\n          }\n\n          // Async chunks are usages of import() for example\n          const dynamicChunks = chunk.getAllAsyncChunks()\n          for (const dynamicChunk of dynamicChunks) {\n            if (isWebpack5) {\n              // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n              for (const module of compilation.chunkGraph.getChunkModulesIterable(\n                chunk\n              )) {\n                // Add module back into the entry chunk\n                chunk.addModule(module)\n              }\n              continue\n            }\n\n            for (const module of dynamicChunk.modulesIterable) {\n              // Webpack 4 has separate GraphHelpers\n              GraphHelpers.connectChunkAndModule(chunk, module)\n            }\n          }\n        }\n      })\n    })\n  }\n}\n"],"names":["ServerlessPlugin","apply","compiler","hooks","compilation","tap","hook","optimizeChunks","optimizeChunksBasic","chunks","chunk","hasEntryModule","dynamicChunks","getAllAsyncChunks","dynamicChunk","module","chunkGraph","getChunkModulesIterable","addModule","modulesIterable","connectChunkAndModule"],"mappings":";;;;AACyC,GAAoC,CAApC,QAAoC;MAQhEA,gBAAgB;IAC3BC,KAAK,CAACC,QAA0B,EAAE,CAAC;QACjCA,QAAQ,CAACC,KAAK,CAACC,WAAW,CAACC,GAAG,CAAC,CAAkB,oBAAGD,WAAW,GAAK,CAAC;YACnE,KAAK,CAACE,IAAI,GAXyB,QAAoC,cAYnEF,WAAW,CAACD,KAAK,CAACI,cAAc,GAChCH,WAAW,CAACD,KAAK,CAACK,mBAAmB;YAEzCF,IAAI,CAACD,GAAG,CAAC,CAAkB,oBAAGI,MAAM,GAAK,CAAC;gBACxC,GAAG,EAAE,KAAK,CAACC,KAAK,IAAID,MAAM,CAAE,CAAC;oBAC3B,EAA2C,AAA3C,yCAA2C;oBAC3C,EAAE,GAAGC,KAAK,CAACC,cAAc,IAAI,CAAC;wBAC5B,QAAQ;oBACV,CAAC;oBAED,EAAkD,AAAlD,gDAAkD;oBAClD,KAAK,CAACC,aAAa,GAAGF,KAAK,CAACG,iBAAiB;oBAC7C,GAAG,EAAE,KAAK,CAACC,YAAY,IAAIF,aAAa,CAAE,CAAC;wBACzC,EAAE,EAzB2B,QAAoC,aAyBjD,CAAC;4BACf,EAA0D,AAA1D,wDAA0D;4BAC1D,GAAG,EAAE,KAAK,CAACG,MAAM,IAAIX,WAAW,CAACY,UAAU,CAACC,uBAAuB,CACjEP,KAAK,EACJ,CAAC;gCACF,EAAuC,AAAvC,qCAAuC;gCACvCA,KAAK,CAACQ,SAAS,CAACH,MAAM;4BACxB,CAAC;4BACD,QAAQ;wBACV,CAAC;wBAED,GAAG,EAAE,KAAK,CAACA,MAAM,IAAID,YAAY,CAACK,eAAe,CAAE,CAAC;4BAClD,EAAsC,AAAtC,oCAAsC;4BArCX,QAAoC,cAsClDC,qBAAqB,CAACV,KAAK,EAAEK,MAAM;wBAClD,CAAC;oBACH,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;;QApCUf,gBAAgB,GAAhBA,gBAAgB"}