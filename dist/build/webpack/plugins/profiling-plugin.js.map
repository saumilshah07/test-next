{"version":3,"sources":["../../../../build/webpack/plugins/profiling-plugin.ts"],"sourcesContent":["import { webpack, isWebpack5 } from 'next/dist/compiled/webpack/webpack'\nimport { trace, Span } from '../../../telemetry/trace'\n\nconst pluginName = 'ProfilingPlugin'\nexport const spans = new WeakMap<any, Span>()\n\nfunction getNormalModuleLoaderHook(compilation: any) {\n  if (isWebpack5) {\n    // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n    return webpack.NormalModule.getCompilationHooks(compilation).loader\n  }\n\n  return compilation.hooks.normalModuleLoader\n}\n\nexport class ProfilingPlugin {\n  compiler: any\n  runWebpackSpan: Span\n\n  constructor({ runWebpackSpan }: { runWebpackSpan: Span }) {\n    this.runWebpackSpan = runWebpackSpan\n  }\n  apply(compiler: any) {\n    this.traceTopLevelHooks(compiler)\n    this.traceCompilationHooks(compiler)\n    this.compiler = compiler\n  }\n\n  traceHookPair(\n    spanName: string,\n    startHook: any,\n    stopHook: any,\n    {\n      parentSpan,\n      attrs,\n      onSetSpan,\n    }: {\n      parentSpan?: () => Span\n      attrs?: any\n      onSetSpan?: (span: Span) => void\n    } = {}\n  ) {\n    let span: Span | undefined\n    startHook.tap(pluginName, () => {\n      span = parentSpan\n        ? parentSpan().traceChild(spanName, attrs ? attrs() : attrs)\n        : trace(spanName, undefined, attrs ? attrs() : attrs)\n\n      onSetSpan?.(span)\n    })\n    stopHook.tap(pluginName, () => {\n      // `stopHook` may be triggered when `startHook` has not in cases\n      // where `stopHook` is used as the terminating event for more\n      // than one pair of hooks.\n      if (!span) {\n        return\n      }\n      span.stop()\n    })\n  }\n\n  traceTopLevelHooks(compiler: any) {\n    this.traceHookPair(\n      'webpack-compilation',\n      isWebpack5 ? compiler.hooks.beforeCompile : compiler.hooks.compile,\n      isWebpack5 ? compiler.hooks.afterCompile : compiler.hooks.done,\n      {\n        parentSpan: () => this.runWebpackSpan,\n        attrs: () => ({ name: compiler.name }),\n        onSetSpan: (span) => spans.set(compiler, span),\n      }\n    )\n\n    if (compiler.options.mode === 'development') {\n      this.traceHookPair(\n        'webpack-invalidated',\n        compiler.hooks.invalid,\n        compiler.hooks.done,\n        { attrs: () => ({ name: compiler.name }) }\n      )\n    }\n  }\n\n  traceCompilationHooks(compiler: any) {\n    this.traceHookPair(\n      'webpack-emit',\n      compiler.hooks.emit,\n      compiler.hooks.afterEmit,\n      { parentSpan: () => this.runWebpackSpan }\n    )\n\n    compiler.hooks.compilation.tap(pluginName, (compilation: any) => {\n      compilation.hooks.buildModule.tap(pluginName, (module: any) => {\n        const compilerSpan = spans.get(compiler)\n        if (!compilerSpan) {\n          return\n        }\n\n        const moduleType = (() => {\n          if (!module.userRequest) {\n            return ''\n          }\n\n          return module.userRequest.split('.').pop()\n        })()\n\n        const issuerModule = compilation?.moduleGraph?.getIssuer(module)\n\n        let span: Span\n\n        const spanName = `build-module${moduleType ? `-${moduleType}` : ''}`\n        const issuerSpan: Span | undefined =\n          issuerModule && spans.get(issuerModule)\n        if (issuerSpan) {\n          span = issuerSpan.traceChild(spanName)\n        } else {\n          span = compilerSpan.traceChild(spanName)\n        }\n        span.setAttribute('name', module.userRequest)\n        spans.set(module, span)\n      })\n\n      getNormalModuleLoaderHook(compilation).tap(\n        pluginName,\n        (loaderContext: any, module: any) => {\n          const moduleSpan = spans.get(module)\n          loaderContext.currentTraceSpan = moduleSpan\n        }\n      )\n\n      compilation.hooks.succeedModule.tap(pluginName, (module: any) => {\n        spans.get(module)?.stop()\n      })\n\n      this.traceHookPair(\n        'webpack-compilation-chunk-graph',\n        compilation.hooks.beforeChunks,\n        compilation.hooks.afterChunks,\n        { parentSpan: () => this.runWebpackSpan }\n      )\n      this.traceHookPair(\n        'webpack-compilation-optimize',\n        compilation.hooks.optimize,\n        compilation.hooks.reviveModules,\n        { parentSpan: () => this.runWebpackSpan }\n      )\n      this.traceHookPair(\n        'webpack-compilation-optimize-modules',\n        compilation.hooks.optimizeModules,\n        compilation.hooks.afterOptimizeModules,\n        { parentSpan: () => this.runWebpackSpan }\n      )\n      this.traceHookPair(\n        'webpack-compilation-optimize-chunks',\n        compilation.hooks.optimizeChunks,\n        compilation.hooks.afterOptimizeChunks,\n        { parentSpan: () => this.runWebpackSpan }\n      )\n      this.traceHookPair(\n        'webpack-compilation-optimize-tree',\n        compilation.hooks.optimizeTree,\n        compilation.hooks.afterOptimizeTree,\n        { parentSpan: () => this.runWebpackSpan }\n      )\n      this.traceHookPair(\n        'webpack-compilation-hash',\n        compilation.hooks.beforeHash,\n        compilation.hooks.afterHash,\n        { parentSpan: () => this.runWebpackSpan }\n      )\n    })\n  }\n}\n"],"names":["pluginName","spans","WeakMap","getNormalModuleLoaderHook","compilation","NormalModule","getCompilationHooks","loader","hooks","normalModuleLoader","ProfilingPlugin","runWebpackSpan","apply","compiler","traceTopLevelHooks","traceCompilationHooks","traceHookPair","spanName","startHook","stopHook","parentSpan","attrs","onSetSpan","span","tap","traceChild","undefined","stop","beforeCompile","compile","afterCompile","done","name","set","options","mode","invalid","emit","afterEmit","buildModule","module","compilerSpan","get","moduleType","userRequest","split","pop","issuerModule","moduleGraph","getIssuer","issuerSpan","setAttribute","loaderContext","moduleSpan","currentTraceSpan","succeedModule","beforeChunks","afterChunks","optimize","reviveModules","optimizeModules","afterOptimizeModules","optimizeChunks","afterOptimizeChunks","optimizeTree","afterOptimizeTree","beforeHash","afterHash"],"mappings":"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"}