{"version":3,"sources":["../../../../build/webpack/plugins/build-stats-plugin.ts"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\nimport { Transform, TransformCallback } from 'stream'\n// @ts-ignore no types package\nimport bfj from 'next/dist/compiled/bfj'\nimport { spans } from './profiling-plugin'\nimport { webpack } from 'next/dist/compiled/webpack/webpack'\n\nconst STATS_VERSION = 0\n\nfunction reduceSize(stats: any) {\n  stats.chunks = stats.chunks.map((chunk: any) => {\n    const reducedChunk: any = {\n      id: chunk.id,\n      files: chunk.files,\n      size: chunk.size,\n    }\n\n    for (const module of chunk.modules) {\n      if (!module.id) {\n        continue\n      }\n\n      if (!reducedChunk.modules) {\n        reducedChunk.modules = []\n      }\n\n      reducedChunk.modules.push(module.id)\n    }\n\n    return reducedChunk\n  })\n\n  stats.modules = stats.modules.map((module: any) => {\n    const reducedModule: any = {\n      type: module.type,\n      moduleType: module.moduleType,\n      size: module.size,\n      name: module.name,\n    }\n\n    if (module.reasons) {\n      for (const reason of module.reasons) {\n        if (!reason.moduleName || reason.moduleId === module.id) {\n          continue\n        }\n\n        if (!reducedModule.reasons) {\n          reducedModule.reasons = []\n        }\n\n        reducedModule.reasons.push(reason.moduleId)\n      }\n    }\n\n    return [module.id, reducedModule]\n  })\n\n  for (const entrypointName in stats.entrypoints) {\n    delete stats.entrypoints[entrypointName].assets\n  }\n\n  return stats\n}\n\nconst THRESHOLD = 16 * 1024\nclass BufferingStream extends Transform {\n  private items: Buffer[] = []\n  private itemsSize = 0\n\n  _transform(\n    chunk: Buffer | string,\n    encoding: BufferEncoding,\n    callback: TransformCallback\n  ): void {\n    const buffer = Buffer.isBuffer(chunk)\n      ? chunk\n      : Buffer.from(chunk as string, encoding)\n    const size = buffer.length\n    if (this.itemsSize > 0 && this.itemsSize + size > THRESHOLD) {\n      this.push(Buffer.concat(this.items))\n      this.itemsSize = 0\n      this.items.length = 0\n    }\n    if (size > THRESHOLD) {\n      this.push(buffer)\n    } else {\n      this.items.push(buffer)\n      this.itemsSize += size\n    }\n\n    callback()\n  }\n\n  _flush(callback: TransformCallback): void {\n    if (this.itemsSize > 0) {\n      this.push(Buffer.concat(this.items))\n      this.itemsSize = 0\n      this.items.length = 0\n    }\n\n    callback()\n  }\n}\n\n// This plugin creates a stats.json for a build when enabled\nexport default class BuildStatsPlugin {\n  private distDir: string\n\n  constructor(options: { distDir: string }) {\n    this.distDir = options.distDir\n  }\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.done.tapAsync(\n      'NextJsBuildStats',\n      async (stats, callback) => {\n        const compilerSpan = spans.get(compiler)\n        try {\n          const writeStatsSpan = compilerSpan!.traceChild('NextJsBuildStats')\n          await writeStatsSpan.traceAsyncFn(() => {\n            return new Promise((resolve, reject) => {\n              const statsJson = reduceSize(\n                stats.toJson({\n                  all: false,\n                  cached: true,\n                  reasons: true,\n                  entrypoints: true,\n                  chunks: true,\n                  errors: false,\n                  warnings: false,\n                  maxModules: Infinity,\n                  chunkModules: true,\n                  modules: true,\n                  // @ts-ignore this option exists\n                  ids: true,\n                })\n              )\n              const fileStream = fs.createWriteStream(\n                path.join(this.distDir, 'next-stats.json'),\n                { highWaterMark: THRESHOLD }\n              )\n              const jsonStream = bfj.streamify({\n                version: STATS_VERSION,\n                stats: statsJson,\n              })\n              jsonStream.pipe(new BufferingStream()).pipe(fileStream)\n              jsonStream.on('error', reject)\n              fileStream.on('error', reject)\n              jsonStream.on('dataError', reject)\n              fileStream.on('close', resolve)\n            })\n          })\n          callback()\n        } catch (err) {\n          callback(err)\n        }\n      }\n    )\n  }\n}\n"],"names":["STATS_VERSION","reduceSize","stats","chunks","map","chunk","reducedChunk","id","files","size","module","modules","push","reducedModule","type","moduleType","name","reasons","reason","moduleName","moduleId","entrypointName","entrypoints","assets","THRESHOLD","BufferingStream","_transform","encoding","callback","buffer","Buffer","isBuffer","from","length","itemsSize","concat","items","_flush","BuildStatsPlugin","options","distDir","apply","compiler","hooks","done","tapAsync","compilerSpan","get","writeStatsSpan","traceChild","traceAsyncFn","Promise","resolve","reject","statsJson","toJson","all","cached","errors","warnings","maxModules","Infinity","chunkModules","ids","fileStream","createWriteStream","join","highWaterMark","jsonStream","streamify","version","pipe","on","err"],"mappings":";;;;;AAAe,GAAI,CAAJ,GAAI;AACF,GAAM,CAAN,KAAM;AACsB,GAAQ,CAAR,OAAQ;AAErC,GAAwB,CAAxB,IAAwB;AAClB,GAAoB,CAApB,gBAAoB;;;;;;AAG1C,KAAK,CAACA,aAAa,GAAG,CAAC;SAEdC,UAAU,CAACC,KAAU,EAAE,CAAC;IAC/BA,KAAK,CAACC,MAAM,GAAGD,KAAK,CAACC,MAAM,CAACC,GAAG,EAAEC,KAAU,GAAK,CAAC;QAC/C,KAAK,CAACC,YAAY,GAAQ,CAAC;YACzBC,EAAE,EAAEF,KAAK,CAACE,EAAE;YACZC,KAAK,EAAEH,KAAK,CAACG,KAAK;YAClBC,IAAI,EAAEJ,KAAK,CAACI,IAAI;QAClB,CAAC;QAED,GAAG,EAAE,KAAK,CAACC,MAAM,IAAIL,KAAK,CAACM,OAAO,CAAE,CAAC;YACnC,EAAE,GAAGD,MAAM,CAACH,EAAE,EAAE,CAAC;gBACf,QAAQ;YACV,CAAC;YAED,EAAE,GAAGD,YAAY,CAACK,OAAO,EAAE,CAAC;gBAC1BL,YAAY,CAACK,OAAO,GAAG,CAAC,CAAC;YAC3B,CAAC;YAEDL,YAAY,CAACK,OAAO,CAACC,IAAI,CAACF,MAAM,CAACH,EAAE;QACrC,CAAC;QAED,MAAM,CAACD,YAAY;IACrB,CAAC;IAEDJ,KAAK,CAACS,OAAO,GAAGT,KAAK,CAACS,OAAO,CAACP,GAAG,EAAEM,MAAW,GAAK,CAAC;QAClD,KAAK,CAACG,aAAa,GAAQ,CAAC;YAC1BC,IAAI,EAAEJ,MAAM,CAACI,IAAI;YACjBC,UAAU,EAAEL,MAAM,CAACK,UAAU;YAC7BN,IAAI,EAAEC,MAAM,CAACD,IAAI;YACjBO,IAAI,EAAEN,MAAM,CAACM,IAAI;QACnB,CAAC;QAED,EAAE,EAAEN,MAAM,CAACO,OAAO,EAAE,CAAC;YACnB,GAAG,EAAE,KAAK,CAACC,MAAM,IAAIR,MAAM,CAACO,OAAO,CAAE,CAAC;gBACpC,EAAE,GAAGC,MAAM,CAACC,UAAU,IAAID,MAAM,CAACE,QAAQ,KAAKV,MAAM,CAACH,EAAE,EAAE,CAAC;oBACxD,QAAQ;gBACV,CAAC;gBAED,EAAE,GAAGM,aAAa,CAACI,OAAO,EAAE,CAAC;oBAC3BJ,aAAa,CAACI,OAAO,GAAG,CAAC,CAAC;gBAC5B,CAAC;gBAEDJ,aAAa,CAACI,OAAO,CAACL,IAAI,CAACM,MAAM,CAACE,QAAQ;YAC5C,CAAC;QACH,CAAC;QAED,MAAM,CAAC,CAACV;YAAAA,MAAM,CAACH,EAAE;YAAEM,aAAa;QAAA,CAAC;IACnC,CAAC;IAED,GAAG,CAAE,KAAK,CAACQ,cAAc,IAAInB,KAAK,CAACoB,WAAW,CAAE,CAAC;QAC/C,MAAM,CAACpB,KAAK,CAACoB,WAAW,CAACD,cAAc,EAAEE,MAAM;IACjD,CAAC;IAED,MAAM,CAACrB,KAAK;AACd,CAAC;AAED,KAAK,CAACsB,SAAS,GAAG,EAAE,GAAG,IAAI;MACrBC,eAAe,SAhEwB,OAAQ;IAoEnDC,UAAU,CACRrB,KAAsB,EACtBsB,QAAwB,EACxBC,SAA2B,EACrB,CAAC;QACP,KAAK,CAACC,MAAM,GAAGC,MAAM,CAACC,QAAQ,CAAC1B,KAAK,IAChCA,KAAK,GACLyB,MAAM,CAACE,IAAI,CAAC3B,KAAK,EAAYsB,QAAQ;QACzC,KAAK,CAAClB,IAAI,GAAGoB,MAAM,CAACI,MAAM;QAC1B,EAAE,EAAE,IAAI,CAACC,SAAS,GAAG,CAAC,IAAI,IAAI,CAACA,SAAS,GAAGzB,IAAI,GAAGe,SAAS,EAAE,CAAC;YAC5D,IAAI,CAACZ,IAAI,CAACkB,MAAM,CAACK,MAAM,CAAC,IAAI,CAACC,KAAK;YAClC,IAAI,CAACF,SAAS,GAAG,CAAC;YAClB,IAAI,CAACE,KAAK,CAACH,MAAM,GAAG,CAAC;QACvB,CAAC;QACD,EAAE,EAAExB,IAAI,GAAGe,SAAS,EAAE,CAAC;YACrB,IAAI,CAACZ,IAAI,CAACiB,MAAM;QAClB,CAAC,MAAM,CAAC;YACN,IAAI,CAACO,KAAK,CAACxB,IAAI,CAACiB,MAAM;YACtB,IAAI,CAACK,SAAS,IAAIzB,IAAI;QACxB,CAAC;QAEDmB,SAAQ;IACV,CAAC;IAEDS,MAAM,CAACT,SAA2B,EAAQ,CAAC;QACzC,EAAE,EAAE,IAAI,CAACM,SAAS,GAAG,CAAC,EAAE,CAAC;YACvB,IAAI,CAACtB,IAAI,CAACkB,MAAM,CAACK,MAAM,CAAC,IAAI,CAACC,KAAK;YAClC,IAAI,CAACF,SAAS,GAAG,CAAC;YAClB,IAAI,CAACE,KAAK,CAACH,MAAM,GAAG,CAAC;QACvB,CAAC;QAEDL,SAAQ;IACV,CAAC;;;QApCH,IAqCC,CApCSQ,KAAK,GAAa,CAAC,CAAC;QAD9B,IAqCC,CAnCSF,SAAS,GAAG,CAAC;;;MAsCFI,gBAAgB;gBAGvBC,OAA4B,CAAE,CAAC;QACzC,IAAI,CAACC,OAAO,GAAGD,OAAO,CAACC,OAAO;IAChC,CAAC;IAEDC,KAAK,CAACC,QAA0B,EAAE,CAAC;QACjCA,QAAQ,CAACC,KAAK,CAACC,IAAI,CAACC,QAAQ,CAC1B,CAAkB,0BACX3C,KAAK,EAAE0B,QAAQ,GAAK,CAAC;YAC1B,KAAK,CAACkB,YAAY,GAhHJ,gBAAoB,OAgHPC,GAAG,CAACL,QAAQ;YACvC,GAAG,CAAC,CAAC;gBACH,KAAK,CAACM,cAAc,GAAGF,YAAY,CAAEG,UAAU,CAAC,CAAkB;gBAClE,KAAK,CAACD,cAAc,CAACE,YAAY,KAAO,CAAC;oBACvC,MAAM,CAAC,GAAG,CAACC,OAAO,EAAEC,OAAO,EAAEC,MAAM,GAAK,CAAC;wBACvC,KAAK,CAACC,SAAS,GAAGrD,UAAU,CAC1BC,KAAK,CAACqD,MAAM,CAAC,CAAC;4BACZC,GAAG,EAAE,KAAK;4BACVC,MAAM,EAAE,IAAI;4BACZxC,OAAO,EAAE,IAAI;4BACbK,WAAW,EAAE,IAAI;4BACjBnB,MAAM,EAAE,IAAI;4BACZuD,MAAM,EAAE,KAAK;4BACbC,QAAQ,EAAE,KAAK;4BACfC,UAAU,EAAEC,QAAQ;4BACpBC,YAAY,EAAE,IAAI;4BAClBnD,OAAO,EAAE,IAAI;4BACb,EAAgC,AAAhC,8BAAgC;4BAChCoD,GAAG,EAAE,IAAI;wBACX,CAAC;wBAEH,KAAK,CAACC,UAAU,GA1If,GAAI,SA0IiBC,iBAAiB,CAzIpC,KAAM,SA0IFC,IAAI,CAAC,IAAI,CAAC1B,OAAO,EAAE,CAAiB,mBACzC,CAAC;4BAAC2B,aAAa,EAAE3C,SAAS;wBAAC,CAAC;wBAE9B,KAAK,CAAC4C,UAAU,GA1Id,IAAwB,SA0IHC,SAAS,CAAC,CAAC;4BAChCC,OAAO,EAAEtE,aAAa;4BACtBE,KAAK,EAAEoD,SAAS;wBAClB,CAAC;wBACDc,UAAU,CAACG,IAAI,CAAC,GAAG,CAAC9C,eAAe,IAAI8C,IAAI,CAACP,UAAU;wBACtDI,UAAU,CAACI,EAAE,CAAC,CAAO,QAAEnB,MAAM;wBAC7BW,UAAU,CAACQ,EAAE,CAAC,CAAO,QAAEnB,MAAM;wBAC7Be,UAAU,CAACI,EAAE,CAAC,CAAW,YAAEnB,MAAM;wBACjCW,UAAU,CAACQ,EAAE,CAAC,CAAO,QAAEpB,OAAO;oBAChC,CAAC;gBACH,CAAC;gBACDxB,QAAQ;YACV,CAAC,CAAC,KAAK,EAAE6C,GAAG,EAAE,CAAC;gBACb7C,QAAQ,CAAC6C,GAAG;YACd,CAAC;QACH,CAAC;IAEL,CAAC;;kBArDkBnC,gBAAgB"}