{"version":3,"sources":["../../../../build/webpack/plugins/next-drop-client-page-plugin.ts"],"sourcesContent":["import { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { isWebpack5 } from 'next/dist/compiled/webpack/webpack'\nimport { STRING_LITERAL_DROP_BUNDLE } from '../../../shared/lib/constants'\n\nexport const ampFirstEntryNamesMap: WeakMap<\n  webpack.compilation.Compilation,\n  string[]\n> = new WeakMap()\n\nconst PLUGIN_NAME = 'DropAmpFirstPagesPlugin'\n\n// Prevents outputting client pages when they are not needed\nexport class DropClientPage implements webpack.Plugin {\n  ampPages = new Set()\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.compilation.tap(\n      PLUGIN_NAME,\n      (compilation: any, { normalModuleFactory }: any) => {\n        // Recursively look up the issuer till it ends up at the root\n        function findEntryModule(mod: any): webpack.compilation.Module | null {\n          const queue = new Set([mod])\n          for (const module of queue) {\n            if (isWebpack5) {\n              // @ts-ignore TODO: webpack 5 types\n              const incomingConnections =\n                compilation.moduleGraph.getIncomingConnections(module)\n\n              for (const incomingConnection of incomingConnections) {\n                if (!incomingConnection.originModule) return module\n                queue.add(incomingConnection.originModule)\n              }\n              continue\n            }\n\n            for (const reason of module.reasons) {\n              if (!reason.module) return module\n              queue.add(reason.module)\n            }\n          }\n\n          return null\n        }\n\n        function handler(parser: any) {\n          function markAsAmpFirst() {\n            const entryModule = findEntryModule(parser.state.module)\n\n            if (!entryModule) {\n              return\n            }\n\n            // @ts-ignore buildInfo exists on Module\n            entryModule.buildInfo.NEXT_ampFirst = true\n          }\n\n          if (isWebpack5) {\n            parser.hooks.preDeclarator.tap(PLUGIN_NAME, (declarator: any) => {\n              if (declarator?.id?.name === STRING_LITERAL_DROP_BUNDLE) {\n                markAsAmpFirst()\n              }\n            })\n            return\n          }\n\n          parser.hooks.varDeclaration\n            .for(STRING_LITERAL_DROP_BUNDLE)\n            .tap(PLUGIN_NAME, markAsAmpFirst)\n        }\n\n        normalModuleFactory.hooks.parser\n          .for('javascript/auto')\n          .tap(PLUGIN_NAME, handler)\n\n        normalModuleFactory.hooks.parser\n          .for('javascript/esm')\n          .tap(PLUGIN_NAME, handler)\n\n        normalModuleFactory.hooks.parser\n          .for('javascript/dynamic')\n          .tap(PLUGIN_NAME, handler)\n\n        if (!ampFirstEntryNamesMap.has(compilation)) {\n          ampFirstEntryNamesMap.set(compilation, [])\n        }\n\n        const ampFirstEntryNamesItem = ampFirstEntryNamesMap.get(\n          compilation\n        ) as string[]\n\n        compilation.hooks.seal.tap(PLUGIN_NAME, () => {\n          if (isWebpack5) {\n            for (const [name, entryData] of compilation.entries) {\n              for (const dependency of entryData.dependencies) {\n                // @ts-ignore TODO: webpack 5 types\n                const module = compilation.moduleGraph.getModule(dependency)\n                if (module?.buildInfo?.NEXT_ampFirst) {\n                  ampFirstEntryNamesItem.push(name)\n                  // @ts-ignore @types/webpack has outdated types for webpack 5\n                  compilation.entries.delete(name)\n                }\n              }\n            }\n            return\n          }\n          // Remove preparedEntrypoint that has bundle drop marker\n          // This will ensure webpack does not create chunks/bundles for this particular entrypoint\n          for (\n            let i = compilation._preparedEntrypoints.length - 1;\n            i >= 0;\n            i--\n          ) {\n            const entrypoint = compilation._preparedEntrypoints[i]\n            if (entrypoint?.module?.buildInfo?.NEXT_ampFirst) {\n              ampFirstEntryNamesItem.push(entrypoint.name)\n              compilation._preparedEntrypoints.splice(i, 1)\n            }\n          }\n\n          for (let i = compilation.entries.length - 1; i >= 0; i--) {\n            const entryModule = compilation.entries[i]\n            if (entryModule?.buildInfo?.NEXT_ampFirst) {\n              compilation.entries.splice(i, 1)\n            }\n          }\n        })\n      }\n    )\n  }\n}\n"],"names":["ampFirstEntryNamesMap","WeakMap","PLUGIN_NAME","DropClientPage","apply","compiler","hooks","compilation","tap","normalModuleFactory","findEntryModule","mod","queue","Set","module","incomingConnections","moduleGraph","getIncomingConnections","incomingConnection","originModule","add","reason","reasons","handler","parser","markAsAmpFirst","entryModule","state","buildInfo","NEXT_ampFirst","preDeclarator","declarator","id","name","varDeclaration","for","has","set","ampFirstEntryNamesItem","get","seal","entryData","entries","dependency","dependencies","getModule","push","delete","i","_preparedEntrypoints","length","entrypoint","splice","ampPages"],"mappings":";;;;;AAC2B,GAAoC,CAApC,QAAoC;AACpB,GAA+B,CAA/B,UAA+B;AAEnE,KAAK,CAACA,qBAAqB,GAG9B,GAAG,CAACC,OAAO;QAHFD,qBAAqB,GAArBA,qBAAqB;AAKlC,KAAK,CAACE,WAAW,GAAG,CAAyB;MAGhCC,cAAc;IAGzBC,KAAK,CAACC,QAA0B,EAAE,CAAC;QACjCA,QAAQ,CAACC,KAAK,CAACC,WAAW,CAACC,GAAG,CAC5BN,WAAW,GACVK,WAAgB,EAAE,CAAC,CAACE,mBAAmB,EAAM,CAAC,GAAK,CAAC;YACnD,EAA6D,AAA7D,2DAA6D;qBACpDC,eAAe,CAACC,GAAQ,EAAqC,CAAC;gBACrE,KAAK,CAACC,KAAK,GAAG,GAAG,CAACC,GAAG,CAAC,CAACF;oBAAAA,GAAG;gBAAA,CAAC;gBAC3B,GAAG,EAAE,KAAK,CAACG,MAAM,IAAIF,KAAK,CAAE,CAAC;oBAC3B,EAAE,EAtBa,QAAoC,aAsBnC,CAAC;wBACf,EAAmC,AAAnC,iCAAmC;wBACnC,KAAK,CAACG,mBAAmB,GACvBR,WAAW,CAACS,WAAW,CAACC,sBAAsB,CAACH,MAAM;wBAEvD,GAAG,EAAE,KAAK,CAACI,kBAAkB,IAAIH,mBAAmB,CAAE,CAAC;4BACrD,EAAE,GAAGG,kBAAkB,CAACC,YAAY,EAAE,MAAM,CAACL,MAAM;4BACnDF,KAAK,CAACQ,GAAG,CAACF,kBAAkB,CAACC,YAAY;wBAC3C,CAAC;wBACD,QAAQ;oBACV,CAAC;oBAED,GAAG,EAAE,KAAK,CAACE,MAAM,IAAIP,MAAM,CAACQ,OAAO,CAAE,CAAC;wBACpC,EAAE,GAAGD,MAAM,CAACP,MAAM,EAAE,MAAM,CAACA,MAAM;wBACjCF,KAAK,CAACQ,GAAG,CAACC,MAAM,CAACP,MAAM;oBACzB,CAAC;gBACH,CAAC;gBAED,MAAM,CAAC,IAAI;YACb,CAAC;qBAEQS,OAAO,CAACC,MAAW,EAAE,CAAC;yBACpBC,cAAc,GAAG,CAAC;oBACzB,KAAK,CAACC,WAAW,GAAGhB,eAAe,CAACc,MAAM,CAACG,KAAK,CAACb,MAAM;oBAEvD,EAAE,GAAGY,WAAW,EAAE,CAAC;wBACjB,MAAM;oBACR,CAAC;oBAED,EAAwC,AAAxC,sCAAwC;oBACxCA,WAAW,CAACE,SAAS,CAACC,aAAa,GAAG,IAAI;gBAC5C,CAAC;gBAED,EAAE,EAvDe,QAAoC,aAuDrC,CAAC;oBACfL,MAAM,CAAClB,KAAK,CAACwB,aAAa,CAACtB,GAAG,CAACN,WAAW,GAAG6B,UAAe,GAAK,CAAC;4BAC5DA,GAAc;wBAAlB,EAAE,GAAEA,UAAU,aAAVA,UAAU,KAAVA,IAAI,CAAJA,CAAc,GAAdA,IAAI,CAAJA,CAAc,IAAdA,GAAc,GAAdA,UAAU,CAAEC,EAAE,cAAdD,GAAc,KAAdA,IAAI,CAAJA,CAAc,GAAdA,IAAI,CAAJA,CAAc,GAAdA,GAAc,CAAEE,IAAI,MAxDK,UAA+B,6BAwDH,CAAC;4BACxDR,cAAc;wBAChB,CAAC;oBACH,CAAC;oBACD,MAAM;gBACR,CAAC;gBAEDD,MAAM,CAAClB,KAAK,CAAC4B,cAAc,CACxBC,GAAG,CAhE2B,UAA+B,6BAiE7D3B,GAAG,CAACN,WAAW,EAAEuB,cAAc;YACpC,CAAC;YAEDhB,mBAAmB,CAACH,KAAK,CAACkB,MAAM,CAC7BW,GAAG,CAAC,CAAiB,kBACrB3B,GAAG,CAACN,WAAW,EAAEqB,OAAO;YAE3Bd,mBAAmB,CAACH,KAAK,CAACkB,MAAM,CAC7BW,GAAG,CAAC,CAAgB,iBACpB3B,GAAG,CAACN,WAAW,EAAEqB,OAAO;YAE3Bd,mBAAmB,CAACH,KAAK,CAACkB,MAAM,CAC7BW,GAAG,CAAC,CAAoB,qBACxB3B,GAAG,CAACN,WAAW,EAAEqB,OAAO;YAE3B,EAAE,GAAGvB,qBAAqB,CAACoC,GAAG,CAAC7B,WAAW,GAAG,CAAC;gBAC5CP,qBAAqB,CAACqC,GAAG,CAAC9B,WAAW,EAAE,CAAC,CAAC;YAC3C,CAAC;YAED,KAAK,CAAC+B,sBAAsB,GAAGtC,qBAAqB,CAACuC,GAAG,CACtDhC,WAAW;YAGbA,WAAW,CAACD,KAAK,CAACkC,IAAI,CAAChC,GAAG,CAACN,WAAW,MAAQ,CAAC;gBAC7C,EAAE,EA1Fe,QAAoC,aA0FrC,CAAC;oBACf,GAAG,EAAE,KAAK,EAAE+B,IAAI,EAAEQ,SAAS,KAAKlC,WAAW,CAACmC,OAAO,CAAE,CAAC;wBACpD,GAAG,EAAE,KAAK,CAACC,UAAU,IAAIF,SAAS,CAACG,YAAY,CAAE,CAAC;gCAG5C9B,GAAiB;4BAFrB,EAAmC,AAAnC,iCAAmC;4BACnC,KAAK,CAACA,MAAM,GAAGP,WAAW,CAACS,WAAW,CAAC6B,SAAS,CAACF,UAAU;4BAC3D,EAAE,EAAE7B,MAAM,aAANA,MAAM,KAANA,IAAI,CAAJA,CAAiB,GAAjBA,IAAI,CAAJA,CAAiB,IAAjBA,GAAiB,GAAjBA,MAAM,CAAEc,SAAS,cAAjBd,GAAiB,KAAjBA,IAAI,CAAJA,CAAiB,GAAjBA,IAAI,CAAJA,CAAiB,GAAjBA,GAAiB,CAAEe,aAAa,EAAE,CAAC;gCACrCS,sBAAsB,CAACQ,IAAI,CAACb,IAAI;gCAChC,EAA6D,AAA7D,2DAA6D;gCAC7D1B,WAAW,CAACmC,OAAO,CAACK,MAAM,CAACd,IAAI;4BACjC,CAAC;wBACH,CAAC;oBACH,CAAC;oBACD,MAAM;gBACR,CAAC;gBACD,EAAwD,AAAxD,sDAAwD;gBACxD,EAAyF,AAAzF,uFAAyF;gBACzF,GAAG,CACD,GAAG,CAACe,CAAC,GAAGzC,WAAW,CAAC0C,oBAAoB,CAACC,MAAM,GAAG,CAAC,EACnDF,CAAC,IAAI,CAAC,EACNA,CAAC,GACD,CAAC;wBAEGG,IAAkB;oBADtB,KAAK,CAACA,UAAU,GAAG5C,WAAW,CAAC0C,oBAAoB,CAACD,CAAC;oBACrD,EAAE,EAAEG,UAAU,aAAVA,UAAU,KAAVA,IAAI,CAAJA,CAAkB,GAAlBA,IAAI,CAAJA,CAAkB,IAAlBA,IAAkB,GAAlBA,UAAU,CAAErC,MAAM,cAAlBqC,IAAkB,KAAlBA,IAAI,CAAJA,CAAkB,GAAlBA,IAAI,CAAJA,CAAkB,WAAlBA,IAAkB,CAAEvB,SAAS,uBAA7BuB,IAAI,CAAJA,CAAkB,GAAlBA,IAAI,CAAJA,CAAkB,QAAatB,aAAa,EAAE,CAAC;wBACjDS,sBAAsB,CAACQ,IAAI,CAACK,UAAU,CAAClB,IAAI;wBAC3C1B,WAAW,CAAC0C,oBAAoB,CAACG,MAAM,CAACJ,CAAC,EAAE,CAAC;oBAC9C,CAAC;gBACH,CAAC;gBAED,GAAG,CAAE,GAAG,CAACA,EAAC,GAAGzC,WAAW,CAACmC,OAAO,CAACQ,MAAM,GAAG,CAAC,EAAEF,EAAC,IAAI,CAAC,EAAEA,EAAC,GAAI,CAAC;wBAErDtB,IAAsB;oBAD1B,KAAK,CAACA,WAAW,GAAGnB,WAAW,CAACmC,OAAO,CAACM,EAAC;oBACzC,EAAE,EAAEtB,WAAW,aAAXA,WAAW,KAAXA,IAAI,CAAJA,CAAsB,GAAtBA,IAAI,CAAJA,CAAsB,IAAtBA,IAAsB,GAAtBA,WAAW,CAAEE,SAAS,cAAtBF,IAAsB,KAAtBA,IAAI,CAAJA,CAAsB,GAAtBA,IAAI,CAAJA,CAAsB,GAAtBA,IAAsB,CAAEG,aAAa,EAAE,CAAC;wBAC1CtB,WAAW,CAACmC,OAAO,CAACU,MAAM,CAACJ,EAAC,EAAE,CAAC;oBACjC,CAAC;gBACH,CAAC;YACH,CAAC;QACH,CAAC;IAEL,CAAC;;QApHI,IAqHN,CApHCK,QAAQ,GAAG,GAAG,CAACxC,GAAG;;;QADPV,cAAc,GAAdA,cAAc"}