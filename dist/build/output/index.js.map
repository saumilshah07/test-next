{"version":3,"sources":["../../../build/output/index.ts"],"sourcesContent":["import chalk from 'chalk'\nimport stripAnsi from 'next/dist/compiled/strip-ansi'\nimport textTable from 'next/dist/compiled/text-table'\nimport createStore from 'next/dist/compiled/unistore'\nimport formatWebpackMessages from '../../client/dev/error-overlay/format-webpack-messages'\nimport { OutputState, store as consoleStore } from './store'\n\nexport function startedDevelopmentServer(appUrl: string, bindAddr: string) {\n  consoleStore.setState({ appUrl, bindAddr })\n}\n\nlet previousClient: import('webpack').Compiler | null = null\nlet previousServer: import('webpack').Compiler | null = null\n\ntype CompilerDiagnostics = {\n  errors: string[] | null\n  warnings: string[] | null\n}\n\ntype WebpackStatus =\n  | { loading: true }\n  | ({ loading: false } & CompilerDiagnostics)\n\ntype AmpStatus = {\n  message: string\n  line: number\n  col: number\n  specUrl: string | null\n  code: string\n}\n\nexport type AmpPageStatus = {\n  [page: string]: { errors: AmpStatus[]; warnings: AmpStatus[] }\n}\n\ntype BuildStatusStore = {\n  client: WebpackStatus\n  server: WebpackStatus\n  amp: AmpPageStatus\n}\n\n// eslint typescript has a bug with TS enums\n/* eslint-disable no-shadow */\nenum WebpackStatusPhase {\n  COMPILING = 1,\n  COMPILED_WITH_ERRORS = 2,\n  COMPILED_WITH_WARNINGS = 4,\n  COMPILED = 5,\n}\n\nfunction getWebpackStatusPhase(status: WebpackStatus): WebpackStatusPhase {\n  if (status.loading) {\n    return WebpackStatusPhase.COMPILING\n  }\n  if (status.errors) {\n    return WebpackStatusPhase.COMPILED_WITH_ERRORS\n  }\n  if (status.warnings) {\n    return WebpackStatusPhase.COMPILED_WITH_WARNINGS\n  }\n  return WebpackStatusPhase.COMPILED\n}\n\nexport function formatAmpMessages(amp: AmpPageStatus) {\n  let output = chalk.bold('Amp Validation') + '\\n\\n'\n  let messages: string[][] = []\n\n  const chalkError = chalk.red('error')\n  function ampError(page: string, error: AmpStatus) {\n    messages.push([page, chalkError, error.message, error.specUrl || ''])\n  }\n\n  const chalkWarn = chalk.yellow('warn')\n  function ampWarn(page: string, warn: AmpStatus) {\n    messages.push([page, chalkWarn, warn.message, warn.specUrl || ''])\n  }\n\n  for (const page in amp) {\n    let { errors, warnings } = amp[page]\n\n    const devOnlyFilter = (err: AmpStatus) => err.code !== 'DEV_MODE_ONLY'\n    errors = errors.filter(devOnlyFilter)\n    warnings = warnings.filter(devOnlyFilter)\n    if (!(errors.length || warnings.length)) {\n      // Skip page with no non-dev warnings\n      continue\n    }\n\n    if (errors.length) {\n      ampError(page, errors[0])\n      for (let index = 1; index < errors.length; ++index) {\n        ampError('', errors[index])\n      }\n    }\n    if (warnings.length) {\n      ampWarn(errors.length ? '' : page, warnings[0])\n      for (let index = 1; index < warnings.length; ++index) {\n        ampWarn('', warnings[index])\n      }\n    }\n    messages.push(['', '', '', ''])\n  }\n\n  if (!messages.length) {\n    return ''\n  }\n\n  output += textTable(messages, {\n    align: ['l', 'l', 'l', 'l'],\n    stringLength(str: string) {\n      return stripAnsi(str).length\n    },\n  })\n\n  return output\n}\n\nconst buildStore = createStore<BuildStatusStore>()\n\nbuildStore.subscribe((state) => {\n  const { amp, client, server } = state\n\n  const [{ status }] = [\n    { status: client, phase: getWebpackStatusPhase(client) },\n    { status: server, phase: getWebpackStatusPhase(server) },\n  ].sort((a, b) => a.phase.valueOf() - b.phase.valueOf())\n\n  const { bootstrap: bootstrapping, appUrl } = consoleStore.getState()\n  if (bootstrapping && status.loading) {\n    return\n  }\n\n  let partialState: Partial<OutputState> = {\n    bootstrap: false,\n    appUrl: appUrl!,\n  }\n\n  if (status.loading) {\n    consoleStore.setState(\n      { ...partialState, loading: true } as OutputState,\n      true\n    )\n  } else {\n    let { errors, warnings } = status\n\n    if (errors == null) {\n      if (Object.keys(amp).length > 0) {\n        warnings = (warnings || []).concat(formatAmpMessages(amp) || [])\n        if (!warnings.length) warnings = null\n      }\n    }\n\n    consoleStore.setState(\n      {\n        ...partialState,\n        loading: false,\n        typeChecking: false,\n        errors,\n        warnings,\n      } as OutputState,\n      true\n    )\n  }\n})\n\nexport function ampValidation(\n  page: string,\n  errors: AmpStatus[],\n  warnings: AmpStatus[]\n) {\n  const { amp } = buildStore.getState()\n  if (!(errors.length || warnings.length)) {\n    buildStore.setState({\n      amp: Object.keys(amp)\n        .filter((k) => k !== page)\n        .sort()\n        // eslint-disable-next-line no-sequences\n        .reduce((a, c) => ((a[c] = amp[c]), a), {} as AmpPageStatus),\n    })\n    return\n  }\n\n  const newAmp: AmpPageStatus = { ...amp, [page]: { errors, warnings } }\n  buildStore.setState({\n    amp: Object.keys(newAmp)\n      .sort()\n      // eslint-disable-next-line no-sequences\n      .reduce((a, c) => ((a[c] = newAmp[c]), a), {} as AmpPageStatus),\n  })\n}\n\nexport function watchCompilers(\n  client: import('webpack').Compiler,\n  server: import('webpack').Compiler\n) {\n  if (previousClient === client && previousServer === server) {\n    return\n  }\n\n  buildStore.setState({\n    client: { loading: true },\n    server: { loading: true },\n  })\n\n  function tapCompiler(\n    key: string,\n    compiler: any,\n    onEvent: (status: WebpackStatus) => void\n  ) {\n    compiler.hooks.invalid.tap(`NextJsInvalid-${key}`, () => {\n      onEvent({ loading: true })\n    })\n\n    compiler.hooks.done.tap(\n      `NextJsDone-${key}`,\n      (stats: import('webpack').Stats) => {\n        buildStore.setState({ amp: {} })\n\n        const { errors, warnings } = formatWebpackMessages(\n          stats.toJson({ all: false, warnings: true, errors: true })\n        )\n\n        const hasErrors = !!errors?.length\n        const hasWarnings = !!warnings?.length\n\n        onEvent({\n          loading: false,\n          errors: hasErrors ? errors : null,\n          warnings: hasWarnings ? warnings : null,\n        })\n      }\n    )\n  }\n\n  tapCompiler('client', client, (status) =>\n    buildStore.setState({ client: status })\n  )\n  tapCompiler('server', server, (status) =>\n    buildStore.setState({ server: status })\n  )\n\n  previousClient = client\n  previousServer = server\n}\n"],"names":["startedDevelopmentServer","formatAmpMessages","ampValidation","watchCompilers","appUrl","bindAddr","setState","previousClient","previousServer","getWebpackStatusPhase","status","loading","WebpackStatusPhase","COMPILING","errors","COMPILED_WITH_ERRORS","warnings","COMPILED_WITH_WARNINGS","COMPILED","amp","output","bold","messages","chalkError","red","ampError","page","error","push","message","specUrl","chalkWarn","yellow","ampWarn","warn","devOnlyFilter","err","code","filter","length","index","align","stringLength","str","buildStore","subscribe","state","client","server","phase","sort","a","b","valueOf","bootstrap","bootstrapping","getState","partialState","Object","keys","concat","typeChecking","k","reduce","c","newAmp","tapCompiler","key","compiler","onEvent","hooks","invalid","tap","done","stats","toJson","all","hasErrors","hasWarnings"],"mappings":"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"}