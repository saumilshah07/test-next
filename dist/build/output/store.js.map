{"version":3,"sources":["../../../build/output/store.ts"],"sourcesContent":["import createStore from 'next/dist/compiled/unistore'\nimport stripAnsi from 'next/dist/compiled/strip-ansi'\n\nimport * as Log from './log'\n\nexport type OutputState =\n  | { bootstrap: true; appUrl: string | null; bindAddr: string | null }\n  | ({ bootstrap: false; appUrl: string | null; bindAddr: string | null } & (\n      | { loading: true }\n      | {\n          loading: false\n          typeChecking: boolean\n          errors: string[] | null\n          warnings: string[] | null\n        }\n    ))\n\nexport const store = createStore<OutputState>({\n  appUrl: null,\n  bindAddr: null,\n  bootstrap: true,\n})\n\nlet lastStore: OutputState = { appUrl: null, bindAddr: null, bootstrap: true }\nfunction hasStoreChanged(nextStore: OutputState) {\n  if (\n    (\n      [\n        ...new Set([...Object.keys(lastStore), ...Object.keys(nextStore)]),\n      ] as Array<keyof OutputState>\n    ).every((key) => Object.is(lastStore[key], nextStore[key]))\n  ) {\n    return false\n  }\n\n  lastStore = nextStore\n  return true\n}\n\nstore.subscribe((state) => {\n  if (!hasStoreChanged(state)) {\n    return\n  }\n\n  if (state.bootstrap) {\n    if (state.appUrl) {\n      Log.ready(`started server on ${state.bindAddr}, url: ${state.appUrl}`)\n    }\n    return\n  }\n\n  if (state.loading) {\n    Log.wait('compiling...')\n    return\n  }\n\n  if (state.errors) {\n    Log.error(state.errors[0])\n\n    const cleanError = stripAnsi(state.errors[0])\n    if (cleanError.indexOf('SyntaxError') > -1) {\n      const matches = cleanError.match(/\\[.*\\]=/)\n      if (matches) {\n        for (const match of matches) {\n          const prop = (match.split(']').shift() || '').substr(1)\n          console.log(\n            `AMP bind syntax [${prop}]='' is not supported in JSX, use 'data-amp-bind-${prop}' instead. https://nextjs.org/docs/messages/amp-bind-jsx-alt`\n          )\n        }\n        return\n      }\n    }\n\n    return\n  }\n\n  if (state.warnings) {\n    Log.warn(state.warnings.join('\\n\\n'))\n    if (state.appUrl) {\n      Log.info(`ready on ${state.appUrl}`)\n    }\n    return\n  }\n\n  if (state.typeChecking) {\n    Log.info('bundled successfully, waiting for typecheck results...')\n    return\n  }\n\n  Log.event('compiled successfully')\n})\n"],"names":["Log","store","appUrl","bindAddr","bootstrap","lastStore","hasStoreChanged","nextStore","Set","Object","keys","every","key","is","subscribe","state","ready","loading","wait","errors","error","cleanError","indexOf","matches","match","prop","split","shift","substr","console","log","warnings","warn","join","info","typeChecking","event"],"mappings":"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"}