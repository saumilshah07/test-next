{"version":3,"sources":["../../client/use-intersection.tsx"],"sourcesContent":["import { useCallback, useEffect, useRef, useState } from 'react'\nimport {\n  requestIdleCallback,\n  cancelIdleCallback,\n} from './request-idle-callback'\n\ntype UseIntersectionObserverInit = Pick<IntersectionObserverInit, 'rootMargin'>\ntype UseIntersection = { disabled?: boolean } & UseIntersectionObserverInit\ntype ObserveCallback = (isVisible: boolean) => void\ntype Observer = {\n  id: string\n  observer: IntersectionObserver\n  elements: Map<Element, ObserveCallback>\n}\n\nconst hasIntersectionObserver = typeof IntersectionObserver !== 'undefined'\n\nexport function useIntersection<T extends Element>({\n  rootMargin,\n  disabled,\n}: UseIntersection): [(element: T | null) => void, boolean] {\n  const isDisabled: boolean = disabled || !hasIntersectionObserver\n\n  const unobserve = useRef<Function>()\n  const [visible, setVisible] = useState(false)\n\n  const setRef = useCallback(\n    (el: T | null) => {\n      if (unobserve.current) {\n        unobserve.current()\n        unobserve.current = undefined\n      }\n\n      if (isDisabled || visible) return\n\n      if (el && el.tagName) {\n        unobserve.current = observe(\n          el,\n          (isVisible) => isVisible && setVisible(isVisible),\n          { rootMargin }\n        )\n      }\n    },\n    [isDisabled, rootMargin, visible]\n  )\n\n  useEffect(() => {\n    if (!hasIntersectionObserver) {\n      if (!visible) {\n        const idleCallback = requestIdleCallback(() => setVisible(true))\n        return () => cancelIdleCallback(idleCallback)\n      }\n    }\n  }, [visible])\n\n  return [setRef, visible]\n}\n\nfunction observe(\n  element: Element,\n  callback: ObserveCallback,\n  options: UseIntersectionObserverInit\n): () => void {\n  const { id, observer, elements } = createObserver(options)\n  elements.set(element, callback)\n\n  observer.observe(element)\n  return function unobserve(): void {\n    elements.delete(element)\n    observer.unobserve(element)\n\n    // Destroy observer when there's nothing left to watch:\n    if (elements.size === 0) {\n      observer.disconnect()\n      observers.delete(id)\n    }\n  }\n}\n\nconst observers = new Map<string, Observer>()\nfunction createObserver(options: UseIntersectionObserverInit): Observer {\n  const id = options.rootMargin || ''\n  let instance = observers.get(id)\n  if (instance) {\n    return instance\n  }\n\n  const elements = new Map<Element, ObserveCallback>()\n  const observer = new IntersectionObserver((entries) => {\n    entries.forEach((entry) => {\n      const callback = elements.get(entry.target)\n      const isVisible = entry.isIntersecting || entry.intersectionRatio > 0\n      if (callback && isVisible) {\n        callback(isVisible)\n      }\n    })\n  }, options)\n\n  observers.set(\n    id,\n    (instance = {\n      id,\n      observer,\n      elements,\n    })\n  )\n  return instance\n}\n"],"names":["useIntersection","hasIntersectionObserver","IntersectionObserver","rootMargin","disabled","isDisabled","unobserve","visible","setVisible","setRef","el","current","undefined","tagName","observe","isVisible","idleCallback","element","callback","options","id","observer","elements","createObserver","set","delete","size","disconnect","observers","Map","instance","get","entries","forEach","entry","target","isIntersecting","intersectionRatio"],"mappings":"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"}