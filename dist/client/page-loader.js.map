{"version":3,"sources":["../../client/page-loader.ts"],"sourcesContent":["import { ComponentType } from 'react'\nimport { ClientSsgManifest } from '../build'\nimport {\n  addBasePath,\n  addLocale,\n  interpolateAs,\n} from '../shared/lib/router/router'\nimport getAssetPathFromRoute from '../shared/lib/router/utils/get-asset-path-from-route'\nimport { isDynamicRoute } from '../shared/lib/router/utils/is-dynamic'\nimport { parseRelativeUrl } from '../shared/lib/router/utils/parse-relative-url'\nimport { removePathTrailingSlash } from './normalize-trailing-slash'\nimport {\n  createRouteLoader,\n  getClientBuildManifest,\n  RouteLoader,\n} from './route-loader'\n\nfunction normalizeRoute(route: string): string {\n  if (route[0] !== '/') {\n    throw new Error(`Route name should start with a \"/\", got \"${route}\"`)\n  }\n\n  if (route === '/') return route\n  return route.replace(/\\/$/, '')\n}\n\nexport type StyleSheetTuple = { href: string; text: string }\nexport type GoodPageCache = {\n  page: ComponentType\n  mod: any\n  styleSheets: StyleSheetTuple[]\n}\n\nexport default class PageLoader {\n  private buildId: string\n  private assetPrefix: string\n\n  private promisedSsgManifest?: Promise<ClientSsgManifest>\n  private promisedDevPagesManifest?: Promise<any>\n  public routeLoader: RouteLoader\n\n  constructor(buildId: string, assetPrefix: string) {\n    this.routeLoader = createRouteLoader(assetPrefix)\n\n    this.buildId = buildId\n    this.assetPrefix = assetPrefix\n\n    /** @type {Promise<Set<string>>} */\n    this.promisedSsgManifest = new Promise((resolve) => {\n      if ((window as any).__SSG_MANIFEST) {\n        resolve((window as any).__SSG_MANIFEST)\n      } else {\n        ;(window as any).__SSG_MANIFEST_CB = () => {\n          resolve((window as any).__SSG_MANIFEST)\n        }\n      }\n    })\n  }\n\n  getPageList() {\n    if (process.env.NODE_ENV === 'production') {\n      return getClientBuildManifest().then((manifest) => manifest.sortedPages)\n    } else {\n      if ((window as any).__DEV_PAGES_MANIFEST) {\n        return (window as any).__DEV_PAGES_MANIFEST.pages\n      } else {\n        if (!this.promisedDevPagesManifest) {\n          this.promisedDevPagesManifest = fetch(\n            `${this.assetPrefix}/_next/static/development/_devPagesManifest.json`\n          )\n            .then((res) => res.json())\n            .then((manifest) => {\n              ;(window as any).__DEV_PAGES_MANIFEST = manifest\n              return manifest.pages\n            })\n            .catch((err) => {\n              console.log(`Failed to fetch devPagesManifest`, err)\n            })\n        }\n        return this.promisedDevPagesManifest\n      }\n    }\n  }\n\n  /**\n   * @param {string} href the route href (file-system path)\n   * @param {string} asPath the URL as shown in browser (virtual path); used for dynamic routes\n   * @returns {string}\n   */\n  getDataHref(\n    href: string,\n    asPath: string,\n    ssg: boolean,\n    locale?: string | false\n  ): string {\n    const { pathname: hrefPathname, query, search } = parseRelativeUrl(href)\n    const { pathname: asPathname } = parseRelativeUrl(asPath)\n    const route = normalizeRoute(hrefPathname)\n\n    const getHrefForSlug = (path: string) => {\n      const dataRoute = getAssetPathFromRoute(\n        removePathTrailingSlash(addLocale(path, locale)),\n        '.json'\n      )\n      return addBasePath(\n        `/_next/data/${this.buildId}${dataRoute}${ssg ? '' : search}`\n      )\n    }\n\n    const isDynamic: boolean = isDynamicRoute(route)\n    const interpolatedRoute = isDynamic\n      ? interpolateAs(hrefPathname, asPathname, query).result\n      : ''\n\n    return isDynamic\n      ? interpolatedRoute && getHrefForSlug(interpolatedRoute)\n      : getHrefForSlug(route)\n  }\n\n  /**\n   * @param {string} route - the route (file-system path)\n   */\n  _isSsg(route: string): Promise<boolean> {\n    return this.promisedSsgManifest!.then((s: ClientSsgManifest) =>\n      s.has(route)\n    )\n  }\n\n  loadPage(route: string): Promise<GoodPageCache> {\n    return this.routeLoader.loadRoute(route).then((res) => {\n      if ('component' in res) {\n        return {\n          page: res.component,\n          mod: res.exports,\n          styleSheets: res.styles.map((o) => ({\n            href: o.href,\n            text: o.content,\n          })),\n        }\n      }\n      throw res.error\n    })\n  }\n\n  prefetch(route: string): Promise<void> {\n    return this.routeLoader.prefetch(route)\n  }\n}\n"],"names":["normalizeRoute","route","Error","replace","PageLoader","getPageList","process","env","NODE_ENV","then","manifest","sortedPages","window","__DEV_PAGES_MANIFEST","pages","promisedDevPagesManifest","fetch","assetPrefix","res","json","catch","err","console","log","getDataHref","href","asPath","ssg","locale","pathname","hrefPathname","query","search","asPathname","getHrefForSlug","path","dataRoute","buildId","isDynamic","interpolatedRoute","result","_isSsg","promisedSsgManifest","s","has","loadPage","routeLoader","loadRoute","page","component","mod","exports","styleSheets","styles","map","o","text","content","error","prefetch","Promise","resolve","__SSG_MANIFEST","__SSG_MANIFEST_CB"],"mappings":"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"}