{"version":3,"sources":["../../lib/verifyTypeScriptSetup.ts"],"sourcesContent":["import chalk from 'chalk'\nimport path from 'path'\nimport {\n  hasNecessaryDependencies,\n  NecessaryDependencies,\n} from './has-necessary-dependencies'\nimport semver from 'next/dist/compiled/semver'\nimport { CompileError } from './compile-error'\nimport { FatalError } from './fatal-error'\nimport * as log from '../build/output/log'\n\nimport { getTypeScriptIntent } from './typescript/getTypeScriptIntent'\nimport { TypeCheckResult } from './typescript/runTypeCheck'\nimport { writeAppTypeDeclarations } from './typescript/writeAppTypeDeclarations'\nimport { writeConfigurationDefaults } from './typescript/writeConfigurationDefaults'\nimport { missingDepsError } from './typescript/missingDependencyError'\n\nconst requiredPackages = [\n  { file: 'typescript', pkg: 'typescript' },\n  { file: '@types/react/index.d.ts', pkg: '@types/react' },\n  { file: '@types/node/index.d.ts', pkg: '@types/node' },\n]\n\nexport async function verifyTypeScriptSetup(\n  dir: string,\n  pagesDir: string,\n  typeCheckPreflight: boolean,\n  imageImportsEnabled: boolean,\n  cacheDir?: string\n): Promise<{ result?: TypeCheckResult; version: string | null }> {\n  const tsConfigPath = path.join(dir, 'tsconfig.json')\n\n  try {\n    // Check if the project uses TypeScript:\n    const intent = await getTypeScriptIntent(dir, pagesDir)\n    if (!intent) {\n      return { version: null }\n    }\n\n    // Ensure TypeScript and necessary `@types/*` are installed:\n    const deps: NecessaryDependencies = await hasNecessaryDependencies(\n      dir,\n      requiredPackages\n    )\n\n    if (deps.missing?.length > 0) {\n      missingDepsError(dir, deps.missing)\n    }\n\n    // Load TypeScript after we're sure it exists:\n    const ts = (await import(\n      deps.resolved.get('typescript')!\n    )) as typeof import('typescript')\n\n    if (semver.lt(ts.version, '4.3.2')) {\n      log.warn(\n        `Minimum recommended TypeScript version is v4.3.2, older versions can potentially be incompatible with Next.js. Detected: ${ts.version}`\n      )\n    }\n\n    // Reconfigure (or create) the user's `tsconfig.json` for them:\n    await writeConfigurationDefaults(ts, tsConfigPath, intent.firstTimeSetup)\n    // Write out the necessary `next-env.d.ts` file to correctly register\n    // Next.js' types:\n    await writeAppTypeDeclarations(dir, imageImportsEnabled)\n\n    let result\n    if (typeCheckPreflight) {\n      const { runTypeCheck } = require('./typescript/runTypeCheck')\n\n      // Verify the project passes type-checking before we go to webpack phase:\n      result = await runTypeCheck(ts, dir, tsConfigPath, cacheDir)\n    }\n    return { result, version: ts.version }\n  } catch (err) {\n    // These are special errors that should not show a stack trace:\n    if (err instanceof CompileError) {\n      console.error(chalk.red('Failed to compile.\\n'))\n      console.error(err.message)\n      process.exit(1)\n    } else if (err instanceof FatalError) {\n      console.error(err.message)\n      process.exit(1)\n    }\n    throw err\n  }\n}\n"],"names":["verifyTypeScriptSetup","log","requiredPackages","file","pkg","dir","pagesDir","typeCheckPreflight","imageImportsEnabled","cacheDir","tsConfigPath","join","deps","intent","version","missing","length","ts","resolved","get","lt","warn","firstTimeSetup","result","runTypeCheck","require","err","console","error","red","message","process","exit"],"mappings":"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"}