{"version":3,"sources":["../../../telemetry/trace/trace.ts"],"sourcesContent":["import { randomBytes } from 'crypto'\nimport { SpanId } from './shared'\nimport { reporter } from './report'\n\nconst NUM_OF_MICROSEC_IN_SEC = BigInt('1000')\n\nconst getId = () => randomBytes(8).toString('hex')\n\n// eslint typescript has a bug with TS enums\n/* eslint-disable no-shadow */\nexport enum SpanStatus {\n  Started,\n  Stopped,\n}\n\nexport class Span {\n  name: string\n  id: SpanId\n  parentId?: SpanId\n  duration: number | null\n  attrs: { [key: string]: any }\n  status: SpanStatus\n\n  _start: bigint\n\n  constructor(name: string, parentId?: SpanId, attrs?: Object) {\n    this.name = name\n    this.parentId = parentId\n    this.duration = null\n    this.attrs = attrs ? { ...attrs } : {}\n    this.status = SpanStatus.Started\n    this.id = getId()\n    this._start = process.hrtime.bigint()\n  }\n\n  // Durations are reported as microseconds. This gives 1000x the precision\n  // of something like Date.now(), which reports in milliseconds.\n  // Additionally, ~285 years can be safely represented as microseconds as\n  // a float64 in both JSON and JavaScript.\n  stop() {\n    const end: bigint = process.hrtime.bigint()\n    const duration = (end - this._start) / NUM_OF_MICROSEC_IN_SEC\n    this.status = SpanStatus.Stopped\n    if (duration > Number.MAX_SAFE_INTEGER) {\n      throw new Error(`Duration is too long to express as float64: ${duration}`)\n    }\n    const timestamp = this._start / NUM_OF_MICROSEC_IN_SEC\n    reporter.report(\n      this.name,\n      Number(duration),\n      Number(timestamp),\n      this.id,\n      this.parentId,\n      this.attrs\n    )\n  }\n\n  traceChild(name: string, attrs?: Object) {\n    return new Span(name, this.id, attrs)\n  }\n\n  setAttribute(key: string, value: any) {\n    this.attrs[key] = String(value)\n  }\n\n  traceFn(fn: any) {\n    try {\n      return fn()\n    } finally {\n      this.stop()\n    }\n  }\n\n  async traceAsyncFn<T>(fn: () => T | Promise<T>): Promise<T> {\n    try {\n      return await fn()\n    } finally {\n      this.stop()\n    }\n  }\n}\n\nexport const trace = (name: string, parentId?: SpanId, attrs?: Object) => {\n  return new Span(name, parentId, attrs)\n}\n\nexport const flushAllTraces = () => reporter.flushAll()\n"],"names":["NUM_OF_MICROSEC_IN_SEC","BigInt","getId","toString","Span","name","parentId","attrs","duration","status","SpanStatus","Started","id","_start","process","hrtime","bigint","stop","end","Stopped","Number","MAX_SAFE_INTEGER","Error","timestamp","report","traceChild","setAttribute","key","value","String","traceFn","fn","traceAsyncFn","trace","flushAllTraces","flushAll"],"mappings":"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"}