{"version":3,"sources":["../../../telemetry/events/version.ts"],"sourcesContent":["import findUp from 'next/dist/compiled/find-up'\nimport path from 'path'\nimport {\n  CONFIG_FILE,\n  PHASE_DEVELOPMENT_SERVER,\n  PHASE_EXPORT,\n  PHASE_PRODUCTION_BUILD,\n} from '../../shared/lib/constants'\nimport { normalizeConfig } from '../../server/config'\n\nconst EVENT_VERSION = 'NEXT_CLI_SESSION_STARTED'\n\ntype EventCliSessionStarted = {\n  nextVersion: string\n  nodeVersion: string\n  cliCommand: string\n  isSrcDir: boolean | null\n  hasNowJson: boolean\n  isCustomServer: boolean | null\n  hasNextConfig: boolean\n  buildTarget: string\n  hasWebpackConfig: boolean\n  hasBabelConfig: boolean\n  basePathEnabled: boolean\n  i18nEnabled: boolean\n  imageEnabled: boolean\n  locales: string | null\n  localeDomainsCount: number | null\n  localeDetectionEnabled: boolean | null\n  imageDomainsCount: number | null\n  imageSizes: string | null\n  imageLoader: string | null\n  trailingSlashEnabled: boolean\n  reactStrictMode: boolean\n  webpackVersion: number | null\n}\n\nfunction hasBabelConfig(dir: string): boolean {\n  try {\n    const noopFile = path.join(dir, 'noop.js')\n    const res = require('next/dist/compiled/babel/core').loadPartialConfig({\n      cwd: dir,\n      filename: noopFile,\n      sourceFileName: noopFile,\n    }) as any\n    const isForTooling =\n      res.options?.presets?.every(\n        (e: any) => e?.file?.request === 'next/babel'\n      ) && res.options?.plugins?.length === 0\n    return res.hasFilesystemConfig() && !isForTooling\n  } catch {\n    return false\n  }\n}\n\ntype NextConfigurationPhase =\n  | typeof PHASE_DEVELOPMENT_SERVER\n  | typeof PHASE_PRODUCTION_BUILD\n  | typeof PHASE_EXPORT\n\nfunction getNextConfig(\n  phase: NextConfigurationPhase,\n  dir: string\n): { [key: string]: any } | null {\n  try {\n    const configurationPath = findUp.sync(CONFIG_FILE, {\n      cwd: dir,\n    })\n\n    if (configurationPath) {\n      // This should've already been loaded, and thus should be cached / won't\n      // be re-evaluated.\n      const configurationModule = require(configurationPath)\n\n      // Re-normalize the configuration.\n      return normalizeConfig(\n        phase,\n        configurationModule.default || configurationModule\n      )\n    }\n  } catch {\n    // ignored\n  }\n  return null\n}\n\nexport function eventCliSession(\n  phase: NextConfigurationPhase,\n  dir: string,\n  event: Omit<\n    EventCliSessionStarted,\n    | 'nextVersion'\n    | 'nodeVersion'\n    | 'hasNextConfig'\n    | 'buildTarget'\n    | 'hasWebpackConfig'\n    | 'hasBabelConfig'\n    | 'basePathEnabled'\n    | 'i18nEnabled'\n    | 'imageEnabled'\n    | 'locales'\n    | 'localeDomainsCount'\n    | 'localeDetectionEnabled'\n    | 'imageDomainsCount'\n    | 'imageSizes'\n    | 'imageLoader'\n    | 'trailingSlashEnabled'\n    | 'reactStrictMode'\n  >\n): { eventName: string; payload: EventCliSessionStarted }[] {\n  // This should be an invariant, if it fails our build tooling is broken.\n  if (typeof process.env.__NEXT_VERSION !== 'string') {\n    return []\n  }\n\n  const userConfiguration = getNextConfig(phase, dir)\n\n  const { images, i18n } = userConfiguration || {}\n\n  const payload: EventCliSessionStarted = {\n    nextVersion: process.env.__NEXT_VERSION,\n    nodeVersion: process.version,\n    cliCommand: event.cliCommand,\n    isSrcDir: event.isSrcDir,\n    hasNowJson: event.hasNowJson,\n    isCustomServer: event.isCustomServer,\n    hasNextConfig: !!userConfiguration,\n    buildTarget: userConfiguration?.target ?? 'default',\n    hasWebpackConfig: typeof userConfiguration?.webpack === 'function',\n    hasBabelConfig: hasBabelConfig(dir),\n    imageEnabled: !!images,\n    basePathEnabled: !!userConfiguration?.basePath,\n    i18nEnabled: !!i18n,\n    locales: i18n?.locales ? i18n.locales.join(',') : null,\n    localeDomainsCount: i18n?.domains ? i18n.domains.length : null,\n    localeDetectionEnabled: !i18n ? null : i18n.localeDetection !== false,\n    imageDomainsCount: images?.domains ? images.domains.length : null,\n    imageSizes: images?.sizes ? images.sizes.join(',') : null,\n    imageLoader: images?.loader,\n    trailingSlashEnabled: !!userConfiguration?.trailingSlash,\n    reactStrictMode: !!userConfiguration?.reactStrictMode,\n    webpackVersion: event.webpackVersion || null,\n  }\n  return [{ eventName: EVENT_VERSION, payload }]\n}\n"],"names":["eventCliSession","EVENT_VERSION","hasBabelConfig","dir","res","noopFile","join","require","loadPartialConfig","cwd","filename","sourceFileName","isForTooling","options","presets","every","e","file","request","plugins","length","hasFilesystemConfig","getNextConfig","phase","configurationPath","sync","configurationModule","default","event","process","env","__NEXT_VERSION","userConfiguration","images","i18n","payload","nextVersion","nodeVersion","version","cliCommand","isSrcDir","hasNowJson","isCustomServer","hasNextConfig","buildTarget","target","hasWebpackConfig","webpack","imageEnabled","basePathEnabled","basePath","i18nEnabled","locales","localeDomainsCount","domains","localeDetectionEnabled","localeDetection","imageDomainsCount","imageSizes","sizes","imageLoader","loader","trailingSlashEnabled","trailingSlash","reactStrictMode","webpackVersion","eventName"],"mappings":"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"}