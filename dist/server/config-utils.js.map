{"version":3,"sources":["../../server/config-utils.ts"],"sourcesContent":["import path from 'path'\nimport { Worker } from 'jest-worker'\nimport * as Log from '../build/output/log'\nimport { CheckReasons, CheckResult } from './config-utils-worker'\nimport { install, shouldLoadWithWebpack5 } from './config-utils-worker'\nimport { PHASE_PRODUCTION_SERVER } from '../shared/lib/constants'\nimport { getNodeOptionsWithoutInspect } from './lib/utils'\n\nexport { install, shouldLoadWithWebpack5 }\n\nfunction reasonMessage(reason: CheckReasons) {\n  switch (reason) {\n    case 'default':\n      return 'Enabled by default'\n    case 'flag-disabled':\n      return 'webpack5 flag is set to false in next.config.js'\n    case 'test-mode':\n      return 'internal test mode'\n    default:\n      return ''\n  }\n}\n\nexport async function loadWebpackHook(phase: string, dir: string) {\n  let useWebpack5 = true\n  let usesRemovedFlag = false\n  const worker = new Worker(\n    path.resolve(__dirname, './config-utils-worker.js'),\n    {\n      enableWorkerThreads: false,\n      numWorkers: 1,\n      forkOptions: {\n        env: {\n          ...process.env,\n          NODE_OPTIONS: getNodeOptionsWithoutInspect(),\n        },\n      },\n    }\n  ) as Worker & {\n    shouldLoadWithWebpack5: typeof import('./config-utils-worker').shouldLoadWithWebpack5\n  }\n  try {\n    const result: CheckResult = await worker.shouldLoadWithWebpack5(phase, dir)\n    if (result.reason === 'future-flag') {\n      usesRemovedFlag = true\n    } else {\n      if (phase !== PHASE_PRODUCTION_SERVER) {\n        Log.info(\n          `Using webpack ${result.enabled ? '5' : '4'}. Reason: ${reasonMessage(\n            result.reason\n          )} https://nextjs.org/docs/messages/webpack5`\n        )\n      }\n    }\n\n    useWebpack5 = Boolean(result.enabled)\n  } catch {\n    // If this errors, it likely will do so again upon boot, so we just swallow\n    // it here.\n  } finally {\n    worker.end()\n  }\n\n  if (usesRemovedFlag) {\n    throw new Error(\n      '`future.webpack5` in `next.config.js` has moved to the top level `webpack5` flag https://nextjs.org/docs/messages/future-webpack5-moved-to-webpack5'\n    )\n  }\n\n  install(useWebpack5)\n}\n"],"names":["install","shouldLoadWithWebpack5","loadWebpackHook","Log","reasonMessage","reason","phase","dir","useWebpack5","usesRemovedFlag","worker","resolve","__dirname","enableWorkerThreads","numWorkers","forkOptions","env","process","NODE_OPTIONS","result","info","enabled","Boolean","end","Error"],"mappings":";;;;+BAQSA,CAAO;;;eAJgC,kBAAuB;;;+BAIrDC,CAAsB;;;eAJQ,kBAAuB;;;QAmBjDC,eAAe,GAAfA,eAAe;AAvBpB,GAAM,CAAN,KAAM;AACA,GAAa,CAAb,WAAa;AACxBC,GAAG,CAAHA,GAAG;AAEiC,GAAuB,CAAvB,kBAAuB;AAC/B,GAAyB,CAAzB,UAAyB;AACpB,GAAa,CAAb,MAAa;;;;;;;;;;;;;;;;;;;;;;;;;;;;;SAIjDC,aAAa,CAACC,MAAoB,EAAE,CAAC;IAC5C,MAAM,CAAEA,MAAM;QACZ,IAAI,CAAC,CAAS;YACZ,MAAM,CAAC,CAAoB;QAC7B,IAAI,CAAC,CAAe;YAClB,MAAM,CAAC,CAAiD;QAC1D,IAAI,CAAC,CAAW;YACd,MAAM,CAAC,CAAoB;;YAE3B,MAAM,CAAC,CAAE;;AAEf,CAAC;eAEqBH,eAAe,CAACI,KAAa,EAAEC,GAAW,EAAE,CAAC;IACjE,GAAG,CAACC,WAAW,GAAG,IAAI;IACtB,GAAG,CAACC,eAAe,GAAG,KAAK;IAC3B,KAAK,CAACC,MAAM,GAAG,GAAG,CAzBG,WAAa,QADnB,KAAM,SA2BdC,OAAO,CAACC,SAAS,EAAE,CAA0B,4BAClD,CAAC;QACCC,mBAAmB,EAAE,KAAK;QAC1BC,UAAU,EAAE,CAAC;QACbC,WAAW,EAAE,CAAC;YACZC,GAAG,EAAE,CAAC;mBACDC,OAAO,CAACD,GAAG;gBACdE,YAAY,MA5BuB,MAAa;YA6BlD,CAAC;QACH,CAAC;IACH,CAAC;IAIH,GAAG,CAAC,CAAC;QACH,KAAK,CAACC,MAAM,GAAgB,KAAK,CAACT,MAAM,CAACT,sBAAsB,CAACK,KAAK,EAAEC,GAAG;QAC1E,EAAE,EAAEY,MAAM,CAACd,MAAM,KAAK,CAAa,cAAE,CAAC;YACpCI,eAAe,GAAG,IAAI;QACxB,CAAC,MAAM,CAAC;YACN,EAAE,EAAEH,KAAK,KAzCyB,UAAyB,0BAyCpB,CAAC;gBA5ClCH,GAAG,CA6CHiB,IAAI,EACL,cAAc,EAAED,MAAM,CAACE,OAAO,GAAG,CAAG,KAAG,CAAG,GAAC,UAAU,EAAEjB,aAAa,CACnEe,MAAM,CAACd,MAAM,EACb,0CAA0C;YAEhD,CAAC;QACH,CAAC;QAEDG,WAAW,GAAGc,OAAO,CAACH,MAAM,CAACE,OAAO;IACtC,CAAC,CAAC,KAAK,EAAC,CAAC;IACP,EAA2E,AAA3E,yEAA2E;IAC3E,EAAW,AAAX,SAAW;IACb,CAAC,QAAS,CAAC;QACTX,MAAM,CAACa,GAAG;IACZ,CAAC;IAED,EAAE,EAAEd,eAAe,EAAE,CAAC;QACpB,KAAK,CAAC,GAAG,CAACe,KAAK,CACb,CAAqJ;IAEzJ,CAAC;QA/D6C,kBAAuB,UAiE7DhB,WAAW;AACrB,CAAC"}