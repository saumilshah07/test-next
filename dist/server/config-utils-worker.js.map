{"version":3,"sources":["../../server/config-utils-worker.ts"],"sourcesContent":["import { loadEnvConfig } from '@next/env'\nimport findUp from 'next/dist/compiled/find-up'\nimport { init as initWebpack } from 'next/dist/compiled/webpack/webpack'\nimport { CONFIG_FILE, PHASE_DEVELOPMENT_SERVER } from '../shared/lib/constants'\nimport { NextConfig, normalizeConfig } from './config-shared'\nimport * as Log from '../build/output/log'\n\nlet installed: boolean = false\n\nexport function install(useWebpack5: boolean) {\n  if (installed) {\n    return\n  }\n  installed = true\n\n  initWebpack(useWebpack5)\n\n  // hook the Node.js require so that webpack requires are\n  // routed to the bundled and now initialized webpack version\n  require('../build/webpack/require-hook')\n}\n\nexport type CheckReasons =\n  | 'test-mode'\n  | 'default'\n  | 'flag-disabled'\n  | 'future-flag'\n\nexport type CheckResult = {\n  enabled: boolean\n  reason: CheckReasons\n}\n\nexport async function shouldLoadWithWebpack5(\n  phase: string,\n  dir: string\n): Promise<CheckResult> {\n  await loadEnvConfig(dir, phase === PHASE_DEVELOPMENT_SERVER, Log)\n\n  const path = await findUp(CONFIG_FILE, {\n    cwd: dir,\n  })\n\n  if (Number(process.env.NEXT_PRIVATE_TEST_WEBPACK4_MODE) > 0) {\n    return {\n      enabled: false,\n      reason: 'test-mode',\n    }\n  }\n\n  // Use webpack 5 by default in apps that do not have next.config.js\n  if (!path?.length) {\n    return {\n      enabled: true,\n      reason: 'default',\n    }\n  }\n\n  // Default to webpack 4 for backwards compatibility on boot:\n  install(false)\n\n  const userConfigModule = require(path)\n  const userConfig: Partial<NextConfig> = normalizeConfig(\n    phase,\n    userConfigModule.default || userConfigModule\n  )\n\n  if (userConfig.future?.webpack5) {\n    return {\n      enabled: false,\n      reason: 'future-flag',\n    }\n  }\n  if (userConfig.webpack5 === false) {\n    return {\n      enabled: false,\n      reason: 'flag-disabled',\n    }\n  }\n\n  return {\n    enabled: true,\n    reason: 'default',\n  }\n}\n"],"names":["install","shouldLoadWithWebpack5","Log","installed","useWebpack5","require","phase","dir","userConfig","path","cwd","Number","process","env","NEXT_PRIVATE_TEST_WEBPACK4_MODE","enabled","reason","length","userConfigModule","default","future","webpack5"],"mappings":";;;;QASgBA,OAAO,GAAPA,OAAO;QAwBDC,sBAAsB,GAAtBA,sBAAsB;AAjCd,GAAW,CAAX,IAAW;AACtB,GAA4B,CAA5B,OAA4B;AACX,GAAoC,CAApC,QAAoC;AAClB,GAAyB,CAAzB,UAAyB;AACnC,GAAiB,CAAjB,aAAiB;AACjDC,GAAG,CAAHA,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEf,GAAG,CAACC,SAAS,GAAY,KAAK;SAEdH,OAAO,CAACI,WAAoB,EAAE,CAAC;IAC7C,EAAE,EAAED,SAAS,EAAE,CAAC;QACd,MAAM;IACR,CAAC;IACDA,SAAS,GAAG,IAAI;QAXkB,QAAoC,OAa1DC,WAAW;IAEvB,EAAwD,AAAxD,sDAAwD;IACxD,EAA4D,AAA5D,0DAA4D;IAC5DC,OAAO,CAAC,CAA+B;AACzC,CAAC;eAaqBJ,sBAAsB,CAC1CK,KAAa,EACbC,GAAW,EACW,CAAC;QA+BnBC,GAAiB;IA9BrB,KAAK,KArCuB,IAAW,gBAqCnBD,GAAG,EAAED,KAAK,KAlCsB,UAAyB,2BAEnEJ,GAAG;IAkCb,KAAK,CAACO,IAAI,GAAG,KAAK,KAtCD,OAA4B,UAEO,UAAyB,cAoCtC,CAAC;QACtCC,GAAG,EAAEH,GAAG;IACV,CAAC;IAED,EAAE,EAAEI,MAAM,CAACC,OAAO,CAACC,GAAG,CAACC,+BAA+B,IAAI,CAAC,EAAE,CAAC;QAC5D,MAAM,CAAC,CAAC;YACNC,OAAO,EAAE,KAAK;YACdC,MAAM,EAAE,CAAW;QACrB,CAAC;IACH,CAAC;IAED,EAAmE,AAAnE,iEAAmE;IACnE,EAAE,IAAGP,IAAI,aAAJA,IAAI,KAAJA,IAAI,CAAJA,CAAY,GAAZA,IAAI,CAAJA,CAAY,GAAZA,IAAI,CAAEQ,MAAM,GAAE,CAAC;QAClB,MAAM,CAAC,CAAC;YACNF,OAAO,EAAE,IAAI;YACbC,MAAM,EAAE,CAAS;QACnB,CAAC;IACH,CAAC;IAED,EAA4D,AAA5D,0DAA4D;IAC5DhB,OAAO,CAAC,KAAK;IAEb,KAAK,CAACkB,gBAAgB,GAAGb,OAAO,CAACI,IAAI;IACrC,KAAK,CAACD,UAAU,OA1D0B,aAAiB,kBA2DzDF,KAAK,EACLY,gBAAgB,CAACC,OAAO,IAAID,gBAAgB;IAG9C,EAAE,GAAEV,GAAiB,GAAjBA,UAAU,CAACY,MAAM,cAAjBZ,GAAiB,KAAjBA,IAAI,CAAJA,CAA2B,GAA3BA,IAAI,CAAJA,CAA2B,GAA3BA,GAAiB,CAAEa,QAAQ,EAAE,CAAC;QAChC,MAAM,CAAC,CAAC;YACNN,OAAO,EAAE,KAAK;YACdC,MAAM,EAAE,CAAa;QACvB,CAAC;IACH,CAAC;IACD,EAAE,EAAER,UAAU,CAACa,QAAQ,KAAK,KAAK,EAAE,CAAC;QAClC,MAAM,CAAC,CAAC;YACNN,OAAO,EAAE,KAAK;YACdC,MAAM,EAAE,CAAe;QACzB,CAAC;IACH,CAAC;IAED,MAAM,CAAC,CAAC;QACND,OAAO,EAAE,IAAI;QACbC,MAAM,EAAE,CAAS;IACnB,CAAC;AACH,CAAC"}