{"version":3,"sources":["../../../../server/lib/squoosh/impl.ts"],"sourcesContent":["import semver from 'next/dist/compiled/semver'\nimport { codecs as supportedFormats, preprocessors } from './codecs'\nimport ImageData from './image_data'\n\n// Fixed in Node.js 16.5.0 and newer.\n// See https://github.com/nodejs/node/pull/39337\n// Eventually, remove this delay when engines is updated.\n// See https://git.io/JCTr0\nconst FIXED_VERSION = '16.5.0'\nconst DELAY_MS = 1000\nlet _promise: Promise<void> | undefined\n\nfunction delayOnce(ms: number): Promise<void> {\n  if (!_promise) {\n    _promise = new Promise((resolve) => {\n      setTimeout(resolve, ms)\n    })\n  }\n  return _promise\n}\n\nfunction maybeDelay(): Promise<void> {\n  const isAppleM1 = process.arch === 'arm64' && process.platform === 'darwin'\n  if (isAppleM1 && semver.lt(process.version, FIXED_VERSION)) {\n    return delayOnce(DELAY_MS)\n  }\n  return Promise.resolve()\n}\n\nexport async function decodeBuffer(\n  _buffer: Buffer | Uint8Array\n): Promise<ImageData> {\n  const buffer = Buffer.from(_buffer)\n  const firstChunk = buffer.slice(0, 16)\n  const firstChunkString = Array.from(firstChunk)\n    .map((v) => String.fromCodePoint(v))\n    .join('')\n  const key = Object.entries(supportedFormats).find(([, { detectors }]) =>\n    detectors.some((detector) => detector.exec(firstChunkString))\n  )?.[0] as keyof typeof supportedFormats\n  if (!key) {\n    throw Error(`Buffer has an unsupported format`)\n  }\n  const d = await supportedFormats[key].dec()\n  return d.decode(new Uint8Array(buffer))\n}\n\nexport async function rotate(\n  image: ImageData,\n  numRotations: number\n): Promise<ImageData> {\n  image = ImageData.from(image)\n\n  const m = await preprocessors['rotate'].instantiate()\n  return await m(image.data, image.width, image.height, { numRotations })\n}\n\ntype ResizeOpts = { image: ImageData } & (\n  | { width: number; height?: never }\n  | { height: number; width?: never }\n)\n\nexport async function resize({ image, width, height }: ResizeOpts) {\n  image = ImageData.from(image)\n\n  const p = preprocessors['resize']\n  const m = await p.instantiate()\n  await maybeDelay()\n  return await m(image.data, image.width, image.height, {\n    ...p.defaultOptions,\n    width,\n    height,\n  })\n}\n\nexport async function encodeJpeg(\n  image: ImageData,\n  { quality }: { quality: number }\n): Promise<Buffer | Uint8Array> {\n  image = ImageData.from(image)\n\n  const e = supportedFormats['mozjpeg']\n  const m = await e.enc()\n  await maybeDelay()\n  const r = await m.encode!(image.data, image.width, image.height, {\n    ...e.defaultEncoderOptions,\n    quality,\n  })\n  return Buffer.from(r)\n}\n\nexport async function encodeWebp(\n  image: ImageData,\n  { quality }: { quality: number }\n): Promise<Buffer | Uint8Array> {\n  image = ImageData.from(image)\n\n  const e = supportedFormats['webp']\n  const m = await e.enc()\n  await maybeDelay()\n  const r = await m.encode!(image.data, image.width, image.height, {\n    ...e.defaultEncoderOptions,\n    quality,\n  })\n  return Buffer.from(r)\n}\n\nexport async function encodePng(\n  image: ImageData\n): Promise<Buffer | Uint8Array> {\n  image = ImageData.from(image)\n\n  const e = supportedFormats['oxipng']\n  const m = await e.enc()\n  await maybeDelay()\n  const r = await m.encode(image.data, image.width, image.height, {\n    ...e.defaultEncoderOptions,\n  })\n  return Buffer.from(r)\n}\n"],"names":["decodeBuffer","rotate","resize","encodeJpeg","encodeWebp","encodePng","FIXED_VERSION","DELAY_MS","_promise","delayOnce","ms","Promise","resolve","setTimeout","maybeDelay","isAppleM1","process","arch","platform","lt","version","_buffer","Object","buffer","Buffer","from","firstChunk","slice","firstChunkString","Array","map","v","String","fromCodePoint","join","key","entries","find","detectors","some","detector","exec","Error","d","dec","decode","Uint8Array","image","numRotations","m","instantiate","data","width","height","p","defaultOptions","quality","e","enc","r","encode","defaultEncoderOptions"],"mappings":"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"}