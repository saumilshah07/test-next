{"version":3,"sources":["../../server/send-payload.ts"],"sourcesContent":["import { IncomingMessage, ServerResponse } from 'http'\nimport { isResSent } from '../shared/lib/utils'\nimport generateETag from 'etag'\nimport fresh from 'next/dist/compiled/fresh'\nimport { RenderResult } from './utils'\n\nexport type PayloadOptions =\n  | { private: true }\n  | { private: boolean; stateful: true }\n  | { private: boolean; stateful: false; revalidate: number | false }\n\nexport function setRevalidateHeaders(\n  res: ServerResponse,\n  options: PayloadOptions\n) {\n  if (options.private || options.stateful) {\n    if (options.private || !res.hasHeader('Cache-Control')) {\n      res.setHeader(\n        'Cache-Control',\n        `private, no-cache, no-store, max-age=0, must-revalidate`\n      )\n    }\n  } else if (typeof options.revalidate === 'number') {\n    if (options.revalidate < 1) {\n      throw new Error(\n        `invariant: invalid Cache-Control duration provided: ${options.revalidate} < 1`\n      )\n    }\n\n    res.setHeader(\n      'Cache-Control',\n      `s-maxage=${options.revalidate}, stale-while-revalidate`\n    )\n  } else if (options.revalidate === false) {\n    res.setHeader('Cache-Control', `s-maxage=31536000, stale-while-revalidate`)\n  }\n}\n\nexport function sendPayload(\n  req: IncomingMessage,\n  res: ServerResponse,\n  payload: any,\n  type: 'html' | 'json',\n  {\n    generateEtags,\n    poweredByHeader,\n  }: { generateEtags: boolean; poweredByHeader: boolean },\n  options?: PayloadOptions\n): void {\n  sendRenderResult({\n    req,\n    res,\n    resultOrPayload: payload,\n    type,\n    generateEtags,\n    poweredByHeader,\n    options,\n  })\n}\n\nexport async function sendRenderResult({\n  req,\n  res,\n  resultOrPayload,\n  type,\n  generateEtags,\n  poweredByHeader,\n  options,\n}: {\n  req: IncomingMessage\n  res: ServerResponse\n  resultOrPayload: RenderResult | string\n  type: 'html' | 'json'\n  generateEtags: boolean\n  poweredByHeader: boolean\n  options?: PayloadOptions\n}): Promise<void> {\n  if (isResSent(res)) {\n    return\n  }\n\n  if (poweredByHeader && type === 'html') {\n    res.setHeader('X-Powered-By', 'Next.js')\n  }\n\n  const isPayload = typeof resultOrPayload === 'string'\n\n  if (isPayload) {\n    const etag = generateEtags\n      ? generateETag(resultOrPayload as string)\n      : undefined\n    if (sendEtagResponse(req, res, etag)) {\n      return\n    }\n  }\n\n  if (!res.getHeader('Content-Type')) {\n    res.setHeader(\n      'Content-Type',\n      type === 'json' ? 'application/json' : 'text/html; charset=utf-8'\n    )\n  }\n\n  if (isPayload) {\n    res.setHeader(\n      'Content-Length',\n      Buffer.byteLength(resultOrPayload as string)\n    )\n  }\n\n  if (options != null) {\n    setRevalidateHeaders(res, options)\n  }\n\n  if (req.method === 'HEAD') {\n    res.end(null)\n  } else if (isPayload) {\n    res.end(resultOrPayload as string)\n  } else {\n    const maybeFlush =\n      typeof (res as any).flush === 'function'\n        ? () => (res as any).flush()\n        : () => {}\n    await (resultOrPayload as RenderResult).forEach((chunk) => {\n      res.write(chunk)\n      maybeFlush()\n    })\n    res.end()\n  }\n}\n\nexport function sendEtagResponse(\n  req: IncomingMessage,\n  res: ServerResponse,\n  etag: string | undefined\n): boolean {\n  if (etag) {\n    /**\n     * The server generating a 304 response MUST generate any of the\n     * following header fields that would have been sent in a 200 (OK)\n     * response to the same request: Cache-Control, Content-Location, Date,\n     * ETag, Expires, and Vary. https://tools.ietf.org/html/rfc7232#section-4.1\n     */\n    res.setHeader('ETag', etag)\n  }\n\n  if (fresh(req.headers, { etag })) {\n    res.statusCode = 304\n    res.end()\n    return true\n  }\n\n  return false\n}\n"],"names":["setRevalidateHeaders","sendPayload","sendRenderResult","sendEtagResponse","res","options","private","stateful","hasHeader","setHeader","revalidate","Error","req","payload","type","generateEtags","poweredByHeader","resultOrPayload","isPayload","etag","undefined","getHeader","Buffer","byteLength","method","end","maybeFlush","flush","forEach","chunk","write","headers","statusCode"],"mappings":"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"}